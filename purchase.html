<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê³  ê´€ë¦¬ - ERP</title>
    <link rel="stylesheet" href="style.css">
    <script>
    if (localStorage.getItem('erp_auth') !== 'ok') {
        location.href = 'login.html';
    }
</script>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="payment.html">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html" class="active">ì…ê³ </a></li>
                <li><a href="supplypayment.html">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="monthly.html">ì›”ë³„ì§‘ê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì…ê³  ê´€ë¦¬</h1>
            </div>

            <section class="card">
                <h2>ìƒˆ ì…ê³  ë“±ë¡ (ì—¬ëŸ¬ í’ˆëª©)</h2>
                
                <div class="common-info-section">
                    <h3>ğŸ“… ê³µí†µ ì •ë³´</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="purchase-date">ì…ê³ ì¼ *</label>
                            <input type="date" id="purchase-date" required>
                        </div>
                        <div class="form-group">
                            <label for="purchase-supplier">ê³µê¸‰ì—…ì²´ *</label>
                            <select id="purchase-supplier" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="items-section">
                    <h3>ğŸ“¦ í’ˆëª© ì •ë³´</h3>
                    <div id="items-container"></div>
                    
                    <button type="button" class="btn btn-secondary" onclick="addItemRow()" style="margin-top: 1rem;">
                        â• í’ˆëª© ì¶”ê°€
                    </button>
                </div>

                <div class="total-section">
                    <h3>ğŸ’° ì „ì²´ í•©ê³„</h3>
                    <div class="total-display">
                        <div class="total-row">
                            <span class="total-label">ì´ ê³µê¸‰ê°€:</span>
                            <span class="total-value" id="total-supply-price">0ì›</span>
                        </div>
                        <div class="total-row">
                            <span class="total-label">ì´ ë¶€ê°€ì„¸:</span>
                            <span class="total-value" id="total-vat">0ì›</span>
                        </div>
                        <div class="total-row total-main">
                            <span class="total-label">ì´ ê¸ˆì•¡:</span>
                            <span class="total-value" id="total-amount">0ì›</span>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="handleMultiPurchaseSubmit()">ì¼ê´„ ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">ì´ˆê¸°í™”</button>
                </div>
            </section>

            <section class="card">
                <h2>ì…ê³  ë‚´ì—­</h2>
                
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filter-supplier">ê³µê¸‰ì—…ì²´</label>
                            <select id="filter-supplier">
                                <option value="">ì „ì²´</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="filter-start">ì‹œì‘ì¼</label>
                            <input type="date" id="filter-start">
                        </div>
                        <div class="form-group">
                            <label for="filter-end">ì¢…ë£Œì¼</label>
                            <input type="date" id="filter-end">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="loadPurchases()">ì¡°íšŒ</button>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ì…ê³ ì¼</th>
                                <th>ê³µê¸‰ì—…ì²´</th>
                                <th>í’ˆëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ë‹¨ê°€</th>
                                <th>ê³µê¸‰ê°€</th>
                                <th>ë¶€ê°€ì„¸</th>
                                <th>í•©ê³„</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="purchases-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let itemCounter = 0;
        let availableItems = [];

        document.addEventListener('DOMContentLoaded', async function() {
            setTodayDate();
            await loadSuppliers();
            await loadItems();
            await loadPurchases();
            addItemRow();
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('purchase-date').value = today;
        }

        async function loadSuppliers() {
            const result = await getCompanies('ê³µê¸‰ì—…ì²´');
            if (result.success && result.data.length > 0) {
                const select = document.getElementById('purchase-supplier');
                const filterSelect = document.getElementById('filter-supplier');
                select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                filterSelect.innerHTML = '<option value="">ì „ì²´</option>';
                result.data.forEach(company => {
                    select.innerHTML += `<option value="${company.name}">${company.name}</option>`;
                    filterSelect.innerHTML += `<option value="${company.name}">${company.name}</option>`;
                });
            }
        }

        async function loadItems() {
            const result = await getItems();
            if (result.success && result.data.length > 0) {
                availableItems = result.data;
            }
        }

        function addItemRow() {
            itemCounter++;
            const container = document.getElementById('items-container');
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = `item-row-${itemCounter}`;
            
            let itemOptions = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            availableItems.forEach(item => {
                itemOptions += `<option value="${item.name}">${item.name}</option>`;
            });
            
            itemRow.innerHTML = `
                <div class="item-row-header">
                    <h4>í’ˆëª© ${itemCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItemRow(${itemCounter})">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>í’ˆëª© *</label>
                        <select class="item-select" required>${itemOptions}</select>
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ *</label>
                        <input type="number" class="item-quantity" min="0" step="0.01" value="1" oninput="calculateItemTotal(${itemCounter})" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ *</label>
                        <input type="number" class="item-price" min="0" oninput="calculateItemTotal(${itemCounter})" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸</label>
                        <select class="item-vat-included" onchange="calculateItemTotal(${itemCounter})">
                            <option value="included">í¬í•¨</option>
                            <option value="excluded">ë³„ë„</option>
                            <option value="exempt">ë©´ì„¸</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê³µê¸‰ê°€</label>
                        <input type="text" class="item-supply-price" readonly>
                    </div>
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸</label>
                        <input type="text" class="item-vat" readonly>
                    </div>
                    <div class="form-group">
                        <label>í•©ê³„</label>
                        <input type="text" class="item-total" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¹„ê³ </label>
                        <input type="text" class="item-note" placeholder="ì…ê³  ê´€ë ¨ ë©”ëª¨">
                    </div>
                    <div class="form-group">
                        <label>ì´ë ¥ë²ˆí˜¸</label>
                        <input type="text" class="item-trace-number" placeholder="012345678901" maxlength="20">
                    </div>
                </div>
            `;
            container.appendChild(itemRow);
        }

        function removeItemRow(itemId) {
            const row = document.getElementById(`item-row-${itemId}`);
            if (row) { row.remove(); calculateGrandTotal(); }
        }

        function calculateItemTotal(itemId) {
            const row = document.getElementById(`item-row-${itemId}`);
            const quantity = Number(row.querySelector('.item-quantity').value) || 0;
            const price = Number(row.querySelector('.item-price').value) || 0;
            const vatMode = row.querySelector('.item-vat-included').value;
            const vatInput = row.querySelector('.item-vat');

            let supplyPrice, vat, total;

            if (vatMode === 'exempt') {
                // ë©´ì„¸: ë¶€ê°€ì„¸ ì—†ìŒ
                total = quantity * price;
                supplyPrice = total;
                vat = 0;
                vatInput.value = 'ë©´ì„¸';
                vatInput.style.color = '#388e3c';
                vatInput.style.fontWeight = 'bold';
            } else if (vatMode === 'included') {
                // ë¶€ê°€ì„¸ í¬í•¨
                total = quantity * price;
                supplyPrice = Math.round(total / 1.1);
                vat = total - supplyPrice;
                vatInput.value = formatCurrency(vat);
                vatInput.style.color = '';
                vatInput.style.fontWeight = '';
            } else {
                // ë¶€ê°€ì„¸ ë³„ë„
                supplyPrice = quantity * price;
                vat = Math.round(supplyPrice * 0.1);
                total = supplyPrice + vat;
                vatInput.value = formatCurrency(vat);
                vatInput.style.color = '';
                vatInput.style.fontWeight = '';
            }

            row.querySelector('.item-supply-price').value = formatCurrency(supplyPrice);
            row.querySelector('.item-total').value = formatCurrency(total);
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let totalSupply = 0, totalVat = 0, grandTotal = 0;
            document.querySelectorAll('.item-row').forEach(row => {
                const quantity = Number(row.querySelector('.item-quantity').value) || 0;
                const price = Number(row.querySelector('.item-price').value) || 0;
                const vatMode = row.querySelector('.item-vat-included').value;
                let supply, vat, total;

                if (vatMode === 'exempt') {
                    total = quantity * price;
                    supply = total;
                    vat = 0;
                } else if (vatMode === 'included') {
                    total = quantity * price;
                    supply = Math.round(total / 1.1);
                    vat = total - supply;
                } else {
                    supply = quantity * price;
                    vat = Math.round(supply * 0.1);
                    total = supply + vat;
                }
                totalSupply += supply; totalVat += vat; grandTotal += total;
            });
            document.getElementById('total-supply-price').textContent = formatCurrency(totalSupply);
            document.getElementById('total-vat').textContent = formatCurrency(totalVat);
            document.getElementById('total-amount').textContent = formatCurrency(grandTotal);
        }

        async function handleMultiPurchaseSubmit() {
            const supplier = document.getElementById('purchase-supplier').value;
            const date = document.getElementById('purchase-date').value;
            if (!supplier || !date) { alert('ì…ê³ ì¼ê³¼ ê³µê¸‰ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            
            const rows = document.querySelectorAll('.item-row');
            if (rows.length === 0) { alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í’ˆëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.'); return; }
            
            const items = [];
            let hasError = false;
            
            rows.forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                const quantity = Number(row.querySelector('.item-quantity').value);
                const price = Number(row.querySelector('.item-price').value);
                const note = row.querySelector('.item-note').value;
                const traceNumber = row.querySelector('.item-trace-number').value;
                if (!itemSelect.value || !quantity || !price) { hasError = true; return; }
                
                const vatMode = row.querySelector('.item-vat-included').value;
                let supplyPrice, vat, total;

                if (vatMode === 'exempt') {
                    total = quantity * price;
                    supplyPrice = total;
                    vat = 0;
                } else if (vatMode === 'included') {
                    total = quantity * price;
                    supplyPrice = Math.round(total / 1.1);
                    vat = total - supplyPrice;
                } else {
                    supplyPrice = quantity * price;
                    vat = Math.round(supplyPrice * 0.1);
                    total = supplyPrice + vat;
                }

                items.push({ date, supplier, item: itemSelect.value, quantity, price, supplyPrice, vat, total, note, traceNumber: traceNumber || '' });
            });
            
            if (hasError) { alert('ëª¨ë“  í’ˆëª©ì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            
            let successCount = 0;
            for (const item of items) {
                const result = await addPurchase(item);
                if (result.success) successCount++;
            }
            
            if (successCount === items.length) {
                alert(`${successCount}ê°œ í’ˆëª©ì´ ì…ê³  ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                resetForm();
            } else {
                alert(`${successCount}/${items.length}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
            await loadPurchases();
        }

        function resetForm() {
            document.getElementById('purchase-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('purchase-supplier').value = '';
            document.getElementById('items-container').innerHTML = '';
            itemCounter = 0;
            addItemRow();
            calculateGrandTotal();
        }

        async function loadPurchases() {
            const tbody = document.getElementById('purchases-tbody');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            
            const params = {};
            const supplier = document.getElementById('filter-supplier').value;
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;
            if (supplier) params.supplier = supplier;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            const result = await getPurchases(params);
            if (result.success) {
                if (result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">ì…ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }
                let html = '';
                result.data.forEach(purchase => {
                    html += `<tr>
                        <td>${formatDate(purchase.date)}</td>
                        <td>${purchase.supplier}</td>
                        <td>${purchase.item}</td>
                        <td class="text-right">${purchase.quantity}</td>
                        <td class="text-right">${formatCurrency(purchase.price)}</td>
                        <td class="text-right">${formatCurrency(purchase.supplyPrice)}</td>
                        <td class="text-right">${formatCurrency(purchase.vat)}</td>
                        <td class="text-right"><strong>${formatCurrency(purchase.total)}</strong></td>
                        <td>${purchase.note || '-'}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">ì…ê³  ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            }
        }
    </script>

    <style>
        .common-info-section, .items-section, .total-section {
            margin-bottom: 2rem; padding: 1.5rem; background: #f9f9f9; border-radius: 8px;
        }
        .item-row {
            background: white; padding: 1.5rem; margin-bottom: 1rem;
            border-radius: 8px; border: 2px solid #e0e0e0;
        }
        .item-row-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #1976d2;
        }
        .item-row-header h4 { margin: 0; color: #1976d2; }
        .total-display { background: white; padding: 1.5rem; border-radius: 8px; }
        .total-row {
            display: flex; justify-content: space-between;
            padding: 0.5rem 0; border-bottom: 1px solid #eee;
        }
        .total-row.total-main {
            border-bottom: none; border-top: 2px solid #1976d2;
            padding-top: 1rem; margin-top: 0.5rem;
        }
        .total-row.total-main .total-label,
        .total-row.total-main .total-value { font-size: 1.25rem; font-weight: bold; color: #1976d2; }
        @media (max-width: 768px) {
            .item-row { padding: 1rem; }
            .item-row-header h4 { font-size: 1rem; }
        }
    </style>
</body>
</html>
