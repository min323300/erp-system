<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ê¸‰ ê´€ë¦¬ - ERP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="payment.html">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="supplypayment.html" class="active">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="monthly.html">ì›”ë³„ì§‘ê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì§€ê¸‰ ê´€ë¦¬</h1>
                <p style="color:#666; font-size:14px; margin-top:4px;">ê³µê¸‰ì—…ì²´ ëŒ€ê¸ˆ ì§€ê¸‰ ë° ë¯¸ì§€ê¸‰ê¸ˆ ê´€ë¦¬</p>
            </div>

            <!-- ì§€ê¸‰ ë“±ë¡ -->
            <section class="card">
                <h2>ì§€ê¸‰ ë“±ë¡</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê³µê¸‰ì—…ì²´ ì„ íƒ *</label>
                        <div class="search-select-wrap">
                            <input type="text" id="supplier-search" placeholder="ê³µê¸‰ì—…ì²´ ê²€ìƒ‰ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                oninput="filterSupplierList(this.value)"
                                onfocus="showSupplierList()"
                                onblur="setTimeout(()=>hideSupplierList(),200)">
                            <input type="hidden" id="payment-supplier">
                            <div id="supplier-dropdown" class="search-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">ì§€ê¸‰ì¼ *</label>
                        <input type="date" id="payment-date" required>
                    </div>
                </div>

                <!-- ë¯¸ì§€ê¸‰ í˜„í™© -->
                <div id="unpaid-section" style="display:none; margin-bottom:20px;">
                    <div style="background:#fff3e0; border-radius:8px; padding:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0; color:#e65100; font-size:15px;">ğŸ“‹ ë¯¸ì§€ê¸‰ í˜„í™©</h3>
                            <span id="total-unpaid-badge" style="background:#e65100; color:white; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:bold;"></span>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì…ê³ ì¼</th>
                                        <th>í’ˆëª©</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>í•©ê³„</th>
                                        <th>ì§€ê¸‰ìƒíƒœ</th>
                                        <th>ë¯¸ì§€ê¸‰ê¸ˆ</th>
                                    </tr>
                                </thead>
                                <tbody id="unpaid-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="no-unpaid-msg" style="display:none; background:#f0fdf4; padding:16px; border-radius:8px; text-align:center; color:#2e7d32; margin-bottom:20px; font-weight:bold;">
                    âœ… ë¯¸ì§€ê¸‰ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤
                </div>

                <!-- ì§€ê¸‰ ì •ë³´ ì…ë ¥ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-amount">ì§€ê¸‰ì•¡ *</label>
                        <input type="number" id="payment-amount" placeholder="ì§€ê¸‰ì•¡ ì…ë ¥" required oninput="onAmountInput()">
                        <small id="amount-hint" style="font-size:12px; margin-top:4px; display:block;"></small>
                    </div>
                    <div class="form-group">
                        <label for="payment-method">ì§€ê¸‰ë°©ë²•</label>
                        <select id="payment-method">
                            <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                            <option value="ì–´ìŒ">ì–´ìŒ</option>
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-note">ë¹„ê³ </label>
                        <input type="text" id="payment-note" placeholder="ë©”ëª¨">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="handlePaymentSubmit()">ğŸ’¸ ì§€ê¸‰ ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">ì´ˆê¸°í™”</button>
                </div>
            </section>

            <!-- ê³µê¸‰ì—…ì²´ë³„ ë¯¸ì§€ê¸‰ê¸ˆ ìš”ì•½ -->
            <section class="card">
                <h2>ê³µê¸‰ì—…ì²´ë³„ ë¯¸ì§€ê¸‰ê¸ˆ í˜„í™©</h2>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ê³µê¸‰ì—…ì²´</th>
                                <th>ì´ ì…ê³ ê¸ˆì•¡</th>
                                <th>ì´ ì§€ê¸‰ì•¡</th>
                                <th>ë¯¸ì§€ê¸‰ê¸ˆ</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="summary-tbody">
                            <tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div id="total-payable-info" style="text-align:right; margin-top:12px; font-size:15px; font-weight:bold; color:#e65100;"></div>
            </section>

            <!-- ì§€ê¸‰ ë‚´ì—­ -->
            <section class="card">
                <h2>ì§€ê¸‰ ë‚´ì—­</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê³µê¸‰ì—…ì²´ í•„í„°</label>
                        <div class="search-select-wrap">
                            <input type="text" id="filter-supplier-search" placeholder="ì „ì²´ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                oninput="filterSupplierList2(this.value)"
                                onfocus="showSupplierList2()"
                                onblur="setTimeout(()=>hideSupplierList2(),200)">
                            <input type="hidden" id="filter-supplier" value="">
                            <div id="supplier-dropdown2" class="search-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="filter-start">ì‹œì‘ì¼</label>
                        <input type="date" id="filter-start">
                    </div>
                    <div class="form-group">
                        <label for="filter-end">ì¢…ë£Œì¼</label>
                        <input type="date" id="filter-end">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadPayments()">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ì§€ê¸‰ì¼</th>
                                <th>ê³µê¸‰ì—…ì²´</th>
                                <th>ì§€ê¸‰ì•¡</th>
                                <th>ì§€ê¸‰ë°©ë²•</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let totalUnpaid = 0;
        let allSuppliers = [];

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            await loadSuppliers();
            await loadPayments();
            await loadSummary();
        });

        // ==========================================
        // ê²€ìƒ‰ ë“œë¡­ë‹¤ìš´
        // ==========================================

        async function loadSuppliers() {
            try {
                const result = await getCompanies('ê³µê¸‰ì—…ì²´');
                if (result.success && result.data.length > 0) {
                    allSuppliers = result.data.map(c => c.name);
                    renderDropdown('supplier-dropdown', allSuppliers, selectSupplier);
                    renderDropdown('supplier-dropdown2', ['ì „ì²´', ...allSuppliers], selectSupplier2);
                }
            } catch(e) { console.error('ê³µê¸‰ì—…ì²´ ë¡œë“œ ì—ëŸ¬:', e); }
        }

        function renderDropdown(id, list, fn) {
            const dd = document.getElementById(id);
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="${fn.name}('${n}')">${n}</div>`
            ).join('');
        }

        function filterSupplierList(val) {
            const filtered = allSuppliers.filter(n => n.includes(val));
            const dd = document.getElementById('supplier-dropdown');
            dd.innerHTML = filtered.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectSupplier('${n}')">${n}</div>`
            ).join('');
            dd.style.display = filtered.length ? 'block' : 'none';
        }

        function filterSupplierList2(val) {
            const list = val ? allSuppliers.filter(n => n.includes(val)) : ['ì „ì²´', ...allSuppliers];
            const dd = document.getElementById('supplier-dropdown2');
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectSupplier2('${n}')">${n}</div>`
            ).join('');
            dd.style.display = list.length ? 'block' : 'none';
        }

        function showSupplierList() { document.getElementById('supplier-dropdown').style.display = 'block'; }
        function hideSupplierList() { document.getElementById('supplier-dropdown').style.display = 'none'; }
        function showSupplierList2() { document.getElementById('supplier-dropdown2').style.display = 'block'; }
        function hideSupplierList2() { document.getElementById('supplier-dropdown2').style.display = 'none'; }

        function selectSupplier(name) {
            document.getElementById('supplier-search').value = name;
            document.getElementById('payment-supplier').value = name;
            document.getElementById('supplier-dropdown').style.display = 'none';
            onSupplierSelect(name);
        }

        function selectSupplier2(name) {
            document.getElementById('filter-supplier-search').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('filter-supplier').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('supplier-dropdown2').style.display = 'none';
        }

        // ==========================================
        // ê³µê¸‰ì—…ì²´ë³„ ë¯¸ì§€ê¸‰ê¸ˆ ìš”ì•½
        // ==========================================

        async function loadSummary() {
            const tbody = document.getElementById('summary-tbody');
            try {
                const [purchaseResult, paymentResult] = await Promise.all([
                    getPurchases({}),
                    getSupplierPayments({})
                ]);

                if (!purchaseResult.success) return;

                // ê³µê¸‰ì—…ì²´ë³„ ì´ ì…ê³ ê¸ˆì•¡ ì§‘ê³„
                const supplierData = {};
                purchaseResult.data.forEach(p => {
                    const s = p.supplier;
                    if (!supplierData[s]) supplierData[s] = { total: 0, unpaid: 0 };
                    supplierData[s].total += p.total || 0;
                    supplierData[s].unpaid += p.unpaid || 0;
                });

                // ì´ ì§€ê¸‰ì•¡ ì§‘ê³„
                const paidMap = {};
                if (paymentResult.success) {
                    paymentResult.data.forEach(p => {
                        paidMap[p.supplier] = (paidMap[p.supplier] || 0) + (p.amount || 0);
                    });
                }

                let totalPayable = 0;
                let html = '';
                Object.entries(supplierData).forEach(([name, d]) => {
                    const paid = paidMap[name] || 0;
                    const unpaid = Math.max(0, d.total - paid); // âœ… ì´ì…ê³  - ì´ì§€ê¸‰ = ì‹¤ì œ ë¯¸ì§€ê¸‰
                    totalPayable += unpaid;
                    const statusBadge = unpaid <= 0
                        ? '<span class="badge badge-success">ì™„ë‚©</span>'
                        : paid > 0
                        ? '<span class="badge badge-warning">ë¶€ë¶„ì§€ê¸‰</span>'
                        : '<span class="badge badge-danger">ë¯¸ì§€ê¸‰</span>';
                    html += `<tr>
                        <td><strong>${name}</strong></td>
                        <td class="text-right">${d.total.toLocaleString()}ì›</td>
                        <td class="text-right" style="color:#1976d2;">${paid.toLocaleString()}ì›</td>
                        <td class="text-right" style="color:${unpaid>0?'#e65100':'#2e7d32'}; font-weight:bold;">${unpaid.toLocaleString()}ì›</td>
                        <td class="text-center">${statusBadge}</td>
                    </tr>`;
                });

                tbody.innerHTML = html || '<tr><td colspan="5" class="text-center text-muted">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                document.getElementById('total-payable-info').textContent =
                    `ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ í•©ê³„: ${totalPayable.toLocaleString()}ì›`;

            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">ì¡°íšŒ ì‹¤íŒ¨</td></tr>';
            }
        }

        // ==========================================
        // ê³µê¸‰ì—…ì²´ ì„ íƒ ì‹œ ë¯¸ì§€ê¸‰ í˜„í™© ë¡œë“œ
        // ==========================================

        async function onSupplierSelect(supplier) {
            const section = document.getElementById('unpaid-section');
            const noMsg = document.getElementById('no-unpaid-msg');
            const tbody = document.getElementById('unpaid-tbody');
            const badge = document.getElementById('total-unpaid-badge');
            const hint = document.getElementById('amount-hint');

            totalUnpaid = 0;
            section.style.display = 'none';
            noMsg.style.display = 'none';
            hint.textContent = '';
            if (!supplier) return;

            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            section.style.display = 'block';

            try {
                const result = await getPurchases({ supplier });
                if (!result.success) { section.style.display = 'none'; return; }

                const unpaidList = result.data.filter(p => (p.unpaid || 0) > 0);

                if (unpaidList.length === 0) {
                    section.style.display = 'none';
                    noMsg.style.display = 'block';
                    return;
                }

                totalUnpaid = unpaidList.reduce((sum, p) => sum + (p.unpaid || 0), 0);
                badge.textContent = 'ì´ ë¯¸ì§€ê¸‰ ' + totalUnpaid.toLocaleString() + 'ì›';
                hint.textContent = `ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›`;
                hint.style.color = '#e65100';

                let html = '';
                unpaidList.forEach(p => {
                    const statusCls = p.paymentStatus === 'ë¶€ë¶„ì§€ê¸‰' ? 'badge-warning' : 'badge-danger';
                    html += `<tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${p.item}</td>
                        <td class="text-center">${p.quantity}</td>
                        <td class="text-right">${(p.total||0).toLocaleString()}ì›</td>
                        <td class="text-center"><span class="badge ${statusCls}">${p.paymentStatus||'ë¯¸ì§€ê¸‰'}</span></td>
                        <td class="text-right" style="color:#e65100; font-weight:bold;">${(p.unpaid||0).toLocaleString()}ì›</td>
                    </tr>`;
                });

                tbody.innerHTML = html;
                section.style.display = 'block';

            } catch(e) {
                section.style.display = 'none';
            }
        }

        function onAmountInput() {
            const amount = Number(document.getElementById('payment-amount').value) || 0;
            const hint = document.getElementById('amount-hint');
            if (totalUnpaid > 0 && amount > 0) {
                if (amount >= totalUnpaid) {
                    hint.textContent = `âœ… ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ ${totalUnpaid.toLocaleString()}ì› ì™„ë‚©`;
                    hint.style.color = '#2e7d32';
                } else {
                    hint.textContent = `ì§€ê¸‰ í›„ ì”ì—¬ ë¯¸ì§€ê¸‰ê¸ˆ: ${(totalUnpaid - amount).toLocaleString()}ì›`;
                    hint.style.color = '#e65100';
                }
            } else if (totalUnpaid > 0) {
                hint.textContent = `ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›`;
                hint.style.color = '#e65100';
            }
        }

        async function handlePaymentSubmit() {
            const supplier = document.getElementById('payment-supplier').value;
            const date = document.getElementById('payment-date').value;
            const amount = Number(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;
            const note = document.getElementById('payment-note').value;

            if (!supplier) { alert('ê³µê¸‰ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!date) { alert('ì§€ê¸‰ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!amount || amount <= 0) { alert('ì§€ê¸‰ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            if (totalUnpaid > 0 && amount > totalUnpaid) {
                if (!confirm(`ì§€ê¸‰ì•¡(${amount.toLocaleString()}ì›)ì´ ë¯¸ì§€ê¸‰ê¸ˆ(${totalUnpaid.toLocaleString()}ì›)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            }

            try {
                const result = await addSupplierPayment({
                    date, supplier, amount, method,
                    note: note || (method + ' ì§€ê¸‰')
                });

                if (result.success) {
                    alert(`${supplier} ì§€ê¸‰ ${amount.toLocaleString()}ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    resetForm();
                    await loadPayments();
                    await loadSummary();
                } else {
                    alert('ì§€ê¸‰ ë“±ë¡ ì‹¤íŒ¨: ' + result.message);
                }
            } catch(e) {
                alert('ì§€ê¸‰ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + e.message);
            }
        }

        function resetForm() {
            document.getElementById('supplier-search').value = '';
            document.getElementById('payment-supplier').value = '';
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-method').value = 'ê³„ì¢Œì´ì²´';
            document.getElementById('payment-note').value = '';
            document.getElementById('unpaid-section').style.display = 'none';
            document.getElementById('no-unpaid-msg').style.display = 'none';
            document.getElementById('amount-hint').textContent = '';
            totalUnpaid = 0;
        }

        async function loadPayments() {
            const tbody = document.getElementById('payments-tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            try {
                const params = {};
                const supplier = document.getElementById('filter-supplier').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;
                if (supplier) params.supplier = supplier;
                if (startDate) params.startDate = startDate;
                if (endDate) params.endDate = endDate;

                const result = await getSupplierPayments(params);
                if (!result.success || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì§€ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                const sorted = result.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                let totalPaid = 0;
                let html = '';
                sorted.forEach(p => {
                    totalPaid += p.amount || 0;
                    html += `<tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${p.supplier}</td>
                        <td class="text-right" style="font-weight:bold; color:#e65100;">${(p.amount||0).toLocaleString()}ì›</td>
                        <td class="text-center"><span class="badge badge-success">${p.method||'-'}</span></td>
                        <td>${p.note||'-'}</td>
                    </tr>`;
                });
                html += `<tr style="background:#fff3e0; font-weight:bold;">
                    <td colspan="2" class="text-right">í•©ê³„</td>
                    <td class="text-right" style="color:#e65100;">${totalPaid.toLocaleString()}ì›</td>
                    <td colspan="2"></td>
                </tr>`;
                tbody.innerHTML = html;
            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '-';
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            } catch(e) { return '-'; }
        }
    </script>

    <style>
        .search-select-wrap { position: relative; }
        .search-select-wrap input[type="text"] { width: 100%; }
        .search-dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #ddd; border-radius: 4px;
            max-height: 200px; overflow-y: auto; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .search-item { padding: 10px 14px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f5f5f5; }
        .search-item:hover { background: #fff3e0; color: #e65100; font-weight: bold; }
        .badge-danger { background: #ffebee; color: #c62828; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        .badge-warning { background: #fff3e0; color: #e65100; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    </style>
</body>
</html>
