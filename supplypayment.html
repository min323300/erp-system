<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§€ê¸‰ ê´€ë¦¬ - ERP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="payment.html">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="supplypayment.html" class="active">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì§€ê¸‰ ê´€ë¦¬</h1>
                <p style="color:#666; font-size:14px; margin-top:4px;">ê³µê¸‰ì—…ì²´ ëŒ€ê¸ˆ ì§€ê¸‰ ë° ë¯¸ì§€ê¸‰ê¸ˆ ê´€ë¦¬</p>
            </div>

            <!-- ì§€ê¸‰ ë“±ë¡ -->
            <section class="card">
                <h2>ì§€ê¸‰ ë“±ë¡</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-supplier">ê³µê¸‰ì—…ì²´ ì„ íƒ *</label>
                        <select id="payment-supplier" required onchange="onSupplierSelect(this.value)">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">ì§€ê¸‰ì¼ *</label>
                        <input type="date" id="payment-date" required>
                    </div>
                </div>

                <!-- ë¯¸ì§€ê¸‰ í˜„í™© -->
                <div id="unpaid-section" style="display:none; margin-bottom:20px;">
                    <div style="background:#fff3e0; border-radius:8px; padding:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0; color:#e65100; font-size:15px;">ğŸ“‹ ë¯¸ì§€ê¸‰ í˜„í™©</h3>
                            <span id="total-unpaid-badge" style="background:#e65100; color:white; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:bold;"></span>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ì…ê³ ì¼</th>
                                        <th>í’ˆëª©</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>í•©ê³„</th>
                                        <th>ì§€ê¸‰ìƒíƒœ</th>
                                        <th>ë¯¸ì§€ê¸‰ê¸ˆ</th>
                                    </tr>
                                </thead>
                                <tbody id="unpaid-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="no-unpaid-msg" style="display:none; background:#f5f5f5; padding:16px; border-radius:8px; text-align:center; color:#888; margin-bottom:20px;">
                    âœ… ë¯¸ì§€ê¸‰ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤
                </div>

                <!-- ì§€ê¸‰ ì •ë³´ ì…ë ¥ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-amount">ì§€ê¸‰ì•¡ *</label>
                        <input type="number" id="payment-amount" placeholder="ì§€ê¸‰ì•¡ ì…ë ¥" required oninput="onAmountInput()">
                        <small id="amount-hint" style="font-size:12px; margin-top:4px; display:block;"></small>
                    </div>
                    <div class="form-group">
                        <label for="payment-method">ì§€ê¸‰ë°©ë²•</label>
                        <select id="payment-method">
                            <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                            <option value="ì–´ìŒ">ì–´ìŒ</option>
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-note">ë¹„ê³ </label>
                        <input type="text" id="payment-note" placeholder="ë©”ëª¨">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="handlePaymentSubmit()">ğŸ’¸ ì§€ê¸‰ ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">ì´ˆê¸°í™”</button>
                </div>
            </section>

            <!-- ì§€ê¸‰ ë‚´ì—­ -->
            <section class="card">
                <h2>ì§€ê¸‰ ë‚´ì—­</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-supplier">ê³µê¸‰ì—…ì²´ í•„í„°</label>
                        <select id="filter-supplier">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filter-start">ì‹œì‘ì¼</label>
                        <input type="date" id="filter-start">
                    </div>
                    <div class="form-group">
                        <label for="filter-end">ì¢…ë£Œì¼</label>
                        <input type="date" id="filter-end">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadPayments()">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ì§€ê¸‰ì¼</th>
                                <th>ê³µê¸‰ì—…ì²´</th>
                                <th>ì§€ê¸‰ì•¡</th>
                                <th>ì§€ê¸‰ë°©ë²•</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let totalUnpaid = 0;

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            await loadSuppliers();
            await loadPayments();
        });

        // ==========================================
        // ê³µê¸‰ì—…ì²´ ë¡œë“œ
        // ==========================================

        async function loadSuppliers() {
            try {
                const result = await getCompanies('ê³µê¸‰ì—…ì²´');
                if (result.success && result.data.length > 0) {
                    const sel1 = document.getElementById('payment-supplier');
                    const sel2 = document.getElementById('filter-supplier');
                    result.data.forEach(c => {
                        sel1.appendChild(new Option(c.name, c.name));
                        sel2.appendChild(new Option(c.name, c.name));
                    });
                }
            } catch(e) { console.error('ê³µê¸‰ì—…ì²´ ë¡œë“œ ì—ëŸ¬:', e); }
        }

        // ==========================================
        // ê³µê¸‰ì—…ì²´ ì„ íƒ ì‹œ ë¯¸ì§€ê¸‰ í˜„í™© ë¡œë“œ
        // ==========================================

        async function onSupplierSelect(supplier) {
            const section = document.getElementById('unpaid-section');
            const noMsg = document.getElementById('no-unpaid-msg');
            const tbody = document.getElementById('unpaid-tbody');
            const badge = document.getElementById('total-unpaid-badge');
            const hint = document.getElementById('amount-hint');

            totalUnpaid = 0;
            section.style.display = 'none';
            noMsg.style.display = 'none';
            hint.textContent = '';

            if (!supplier) return;

            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            section.style.display = 'block';

            try {
                const result = await getPurchases({ supplier });
                if (!result.success) { section.style.display = 'none'; return; }

                // ë¯¸ì§€ê¸‰ê¸ˆ ìˆëŠ” í•­ëª©ë§Œ í•„í„°
                const unpaidList = result.data.filter(p => (p.unpaid || 0) > 0);

                if (unpaidList.length === 0) {
                    section.style.display = 'none';
                    noMsg.style.display = 'block';
                    return;
                }

                totalUnpaid = unpaidList.reduce((sum, p) => sum + (p.unpaid || 0), 0);
                badge.textContent = 'ì´ ë¯¸ì§€ê¸‰ ' + totalUnpaid.toLocaleString() + 'ì›';
                hint.textContent = `ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›`;
                hint.style.color = '#e65100';

                let html = '';
                unpaidList.forEach(p => {
                    const statusCls = p.paymentStatus === 'ë¶€ë¶„ì§€ê¸‰' ? 'badge-warning' : 'badge-danger';
                    html += `<tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${p.item}</td>
                        <td class="text-center">${p.quantity}</td>
                        <td class="text-right">${(p.total||0).toLocaleString()}ì›</td>
                        <td class="text-center"><span class="badge ${statusCls}">${p.paymentStatus||'ë¯¸ì§€ê¸‰'}</span></td>
                        <td class="text-right" style="color:#e65100; font-weight:bold;">${(p.unpaid||0).toLocaleString()}ì›</td>
                    </tr>`;
                });

                tbody.innerHTML = html;
                section.style.display = 'block';

            } catch(e) {
                console.error('ë¯¸ì§€ê¸‰ ì¡°íšŒ ì—ëŸ¬:', e);
                section.style.display = 'none';
            }
        }

        // ì§€ê¸‰ì•¡ ì…ë ¥ ì‹œ íŒíŠ¸
        function onAmountInput() {
            const amount = Number(document.getElementById('payment-amount').value) || 0;
            const hint = document.getElementById('amount-hint');
            if (totalUnpaid > 0 && amount > 0) {
                if (amount >= totalUnpaid) {
                    hint.textContent = `âœ… ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ ${totalUnpaid.toLocaleString()}ì› ì™„ë‚©`;
                    hint.style.color = '#2e7d32';
                } else {
                    hint.textContent = `ì§€ê¸‰ í›„ ì”ì—¬ ë¯¸ì§€ê¸‰ê¸ˆ: ${(totalUnpaid - amount).toLocaleString()}ì›`;
                    hint.style.color = '#e65100';
                }
            } else if (totalUnpaid > 0) {
                hint.textContent = `ì „ì²´ ë¯¸ì§€ê¸‰ê¸ˆ: ${totalUnpaid.toLocaleString()}ì›`;
                hint.style.color = '#e65100';
            }
        }

        // ==========================================
        // ì§€ê¸‰ ë“±ë¡
        // ==========================================

        async function handlePaymentSubmit() {
            const supplier = document.getElementById('payment-supplier').value;
            const date = document.getElementById('payment-date').value;
            const amount = Number(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;
            const note = document.getElementById('payment-note').value;

            if (!supplier) { alert('ê³µê¸‰ì—…ì²´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!date) { alert('ì§€ê¸‰ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!amount || amount <= 0) { alert('ì§€ê¸‰ì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            if (totalUnpaid > 0 && amount > totalUnpaid) {
                if (!confirm(`ì§€ê¸‰ì•¡(${amount.toLocaleString()}ì›)ì´ ë¯¸ì§€ê¸‰ê¸ˆ(${totalUnpaid.toLocaleString()}ì›)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            }

            try {
                const result = await addSupplierPayment({
                    date, supplier, amount, method,
                    note: note || (method + ' ì§€ê¸‰')
                });

                if (result.success) {
                    alert(`${supplier} ì§€ê¸‰ ${amount.toLocaleString()}ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në¯¸ì§€ê¸‰ê¸ˆì´ ìë™ ì°¨ê°ë©ë‹ˆë‹¤.`);
                    resetForm();
                    await loadPayments();
                } else {
                    alert('ì§€ê¸‰ ë“±ë¡ ì‹¤íŒ¨: ' + result.message);
                }
            } catch(e) {
                alert('ì§€ê¸‰ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ==========================================
        // í¼ ì´ˆê¸°í™”
        // ==========================================

        function resetForm() {
            document.getElementById('payment-supplier').value = '';
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-method').value = 'ê³„ì¢Œì´ì²´';
            document.getElementById('payment-note').value = '';
            document.getElementById('unpaid-section').style.display = 'none';
            document.getElementById('no-unpaid-msg').style.display = 'none';
            document.getElementById('amount-hint').textContent = '';
            totalUnpaid = 0;
        }

        // ==========================================
        // ì§€ê¸‰ ë‚´ì—­ ë¡œë“œ
        // ==========================================

        async function loadPayments() {
            const tbody = document.getElementById('payments-tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const params = {};
                const supplier = document.getElementById('filter-supplier').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;
                if (supplier) params.supplier = supplier;
                if (startDate) params.startDate = startDate;
                if (endDate) params.endDate = endDate;

                const result = await getSupplierPayments(params);

                if (!result.success || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì§€ê¸‰ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                const sorted = result.data.sort((a, b) => new Date(b.date) - new Date(a.date));
                let html = '';
                sorted.forEach(p => {
                    html += `<tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${p.supplier}</td>
                        <td class="text-right" style="font-weight:bold; color:#e65100;">${(p.amount||0).toLocaleString()}ì›</td>
                        <td class="text-center"><span class="badge badge-success">${p.method||'-'}</span></td>
                        <td>${p.note||'-'}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '-';
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            } catch(e) { return '-'; }
        }
    </script>

    <style>
        .badge-danger {
            background: #ffebee; color: #c62828;
            padding: 2px 8px; border-radius: 12px; font-size: 12px;
        }
    </style>
</body>
</html>
