<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì…ê¸ˆ ê´€ë¦¬ - ERP</title>
    <link rel="stylesheet" href="style.css">
    <script>
    if (localStorage.getItem('erp_auth') !== 'ok') {
        location.href = 'login.html';
    }
</script>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="payment.html" class="active">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="supplypayment.html">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="monthly.html">ì›”ë³„ì§‘ê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì…ê¸ˆ ê´€ë¦¬</h1>
            </div>

            <!-- ì…ê¸ˆ ë“±ë¡ -->
            <section class="card">
                <h2>ì…ê¸ˆ ë“±ë¡</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ ì„ íƒ *</label>
                        <div class="search-select-wrap" id="customer-wrap">
                            <input type="text" id="customer-search" placeholder="ê±°ë˜ì²˜ ê²€ìƒ‰ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                oninput="filterCustomerList(this.value)"
                                onfocus="showCustomerList()"
                                onblur="setTimeout(()=>hideCustomerList(),200)">
                            <input type="hidden" id="payment-customer">
                            <div id="customer-dropdown" class="search-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">ì…ê¸ˆì¼ *</label>
                        <input type="date" id="payment-date" required>
                    </div>
                </div>

                <!-- ë¯¸ìˆ˜ê¸ˆ í˜„í™© -->
                <div id="receivables-section" style="display:none; margin-bottom:20px;">
                    <div style="background:#e3f2fd; border-radius:8px; padding:16px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                            <h3 style="margin:0; color:#1565c0; font-size:15px;">ğŸ“‹ ë¯¸ìˆ˜ê¸ˆ í˜„í™©</h3>
                            <span id="total-receivable-badge" style="background:#1976d2; color:white; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:bold;"></span>
                        </div>
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ë‚ ì§œ</th>
                                        <th>í’ˆëª©</th>
                                        <th>ìˆ˜ëŸ‰</th>
                                        <th>í•©ê³„</th>
                                        <th>ì…ê¸ˆìƒíƒœ</th>
                                        <th>ë¯¸ìˆ˜ê¸ˆ</th>
                                    </tr>
                                </thead>
                                <tbody id="receivables-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="no-receivable-msg" style="display:none; background:#f5f5f5; padding:16px; border-radius:8px; text-align:center; color:#888; margin-bottom:20px;">
                    âœ… ë¯¸ìˆ˜ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤
                </div>

                <!-- ì…ê¸ˆ ì •ë³´ ì…ë ¥ -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="payment-amount">ì…ê¸ˆì•¡ *</label>
                        <input type="number" id="payment-amount" placeholder="ì…ê¸ˆì•¡ ì…ë ¥" required oninput="onAmountInput()">
                        <small id="amount-hint" style="color:#888; font-size:12px; margin-top:4px; display:block;"></small>
                    </div>
                    <div class="form-group">
                        <label for="payment-method">ì…ê¸ˆë°©ë²•</label>
                        <select id="payment-method">
                            <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                            <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                            <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                            <option value="ì–´ìŒ">ì–´ìŒ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-note">ë¹„ê³ </label>
                        <input type="text" id="payment-note" placeholder="ë©”ëª¨">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="handlePaymentSubmit()">ğŸ’° ì…ê¸ˆ ë“±ë¡</button>
                    <button type="button" class="btn btn-secondary" onclick="resetPaymentForm()">ì´ˆê¸°í™”</button>
                </div>
            </section>

            <!-- ì…ê¸ˆ ë‚´ì—­ -->
            <section class="card">
                <h2>ì…ê¸ˆ ë‚´ì—­</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ í•„í„°</label>
                        <div class="search-select-wrap">
                            <input type="text" id="filter-customer-search" placeholder="ì „ì²´ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                oninput="filterCustomerList2(this.value)"
                                onfocus="showCustomerList2()"
                                onblur="setTimeout(()=>hideCustomerList2(),200)">
                            <input type="hidden" id="filter-customer" value="">
                            <div id="customer-dropdown2" class="search-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="filter-start">ì‹œì‘ì¼</label>
                        <input type="date" id="filter-start">
                    </div>
                    <div class="form-group">
                        <label for="filter-end">ì¢…ë£Œì¼</label>
                        <input type="date" id="filter-end">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadPayments()">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ì…ê¸ˆì¼</th>
                                <th>ê±°ë˜ì²˜</th>
                                <th>ì…ê¸ˆì•¡</th>
                                <th>ì…ê¸ˆë°©ë²•</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="payments-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let currentReceivables = [];
        let totalReceivable = 0;

        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            await loadCustomers();
            await loadPayments();
        });

        // ==========================================
        // ê±°ë˜ì²˜ ë¡œë“œ
        // ==========================================

        let allCustomers = [];

        async function loadCustomers() {
            try {
                const result = await getCompanies();
                if (result.success && result.data.length > 0) {
                    allCustomers = result.data.filter(c => c.type === 'ê±°ë˜ì²˜').map(c => c.name);
                    renderDropdown('customer-dropdown', allCustomers, selectCustomer);
                    renderDropdown('customer-dropdown2', ['ì „ì²´', ...allCustomers], selectCustomer2);
                }
            } catch(e) { console.error('ê±°ë˜ì²˜ ë¡œë“œ ì—ëŸ¬:', e); }
        }

        function renderDropdown(id, list, onSelect) {
            const dd = document.getElementById(id);
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="${onSelect.name}('${n}')">${n}</div>`
            ).join('');
        }

        function filterCustomerList(val) {
            const filtered = allCustomers.filter(n => n.includes(val));
            const dd = document.getElementById('customer-dropdown');
            dd.innerHTML = filtered.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectCustomer('${n}')">${n}</div>`
            ).join('');
            dd.style.display = filtered.length ? 'block' : 'none';
        }

        function filterCustomerList2(val) {
            const list = val ? allCustomers.filter(n => n.includes(val)) : ['ì „ì²´', ...allCustomers];
            const dd = document.getElementById('customer-dropdown2');
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectCustomer2('${n}')">${n}</div>`
            ).join('');
            dd.style.display = list.length ? 'block' : 'none';
        }

        function showCustomerList() {
            const dd = document.getElementById('customer-dropdown');
            dd.style.display = 'block';
        }
        function hideCustomerList() {
            document.getElementById('customer-dropdown').style.display = 'none';
        }
        function showCustomerList2() {
            document.getElementById('customer-dropdown2').style.display = 'block';
        }
        function hideCustomerList2() {
            document.getElementById('customer-dropdown2').style.display = 'none';
        }

        function selectCustomer(name) {
            document.getElementById('customer-search').value = name;
            document.getElementById('payment-customer').value = name;
            document.getElementById('customer-dropdown').style.display = 'none';
            onCustomerSelect(name);
        }

        function selectCustomer2(name) {
            document.getElementById('filter-customer-search').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('filter-customer').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('customer-dropdown2').style.display = 'none';
        }

        // ==========================================
        // ê±°ë˜ì²˜ ì„ íƒ ì‹œ ë¯¸ìˆ˜ê¸ˆ í˜„í™© ë¡œë“œ
        // ==========================================

        async function onCustomerSelect(company) {
            const section = document.getElementById('receivables-section');
            const noMsg = document.getElementById('no-receivable-msg');
            const tbody = document.getElementById('receivables-tbody');
            const badge = document.getElementById('total-receivable-badge');
            const hint = document.getElementById('amount-hint');

            currentReceivables = [];
            totalReceivable = 0;
            section.style.display = 'none';
            noMsg.style.display = 'none';
            hint.textContent = '';

            if (!company) return;

            tbody.innerHTML = '<tr><td colspan="6" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            section.style.display = 'block';

            try {
                const result = await getSales({ customer: company });
                if (!result.success) { section.style.display = 'none'; return; }

                // ë¯¸ìˆ˜ê¸ˆ ìˆëŠ” í•­ëª©ë§Œ í•„í„°
                const unpaidSales = result.data.filter(s => (s.unpaid || 0) > 0);

                if (unpaidSales.length === 0) {
                    section.style.display = 'none';
                    noMsg.style.display = 'block';
                    return;
                }

                currentReceivables = unpaidSales;
                totalReceivable = unpaidSales.reduce((sum, s) => sum + (s.unpaid || 0), 0);

                badge.textContent = 'ì´ ë¯¸ìˆ˜ê¸ˆ ' + totalReceivable.toLocaleString() + 'ì›';
                hint.textContent = `ì „ì²´ ë¯¸ìˆ˜ê¸ˆ: ${totalReceivable.toLocaleString()}ì›`;
                hint.style.color = '#c62828';

                let html = '';
                unpaidSales.forEach(sale => {
                    const qty = sale.quantity || 1;
                    const totalAmt = sale.total || 0;   // ì´ë¯¸ ì´ì•¡
                    const unpaidAmt = sale.unpaid || 0; // ì´ë¯¸ ì´ì•¡
                    const badgeCls = sale.paymentStatus === 'ë¶€ë¶„ì…ê¸ˆ' ? 'badge-warning' : 'badge-danger';

                    html += `<tr>
                        <td>${formatDate(sale.date)}</td>
                        <td>${sale.item}</td>
                        <td class="text-center">${qty}</td>
                        <td class="text-right">${totalAmt.toLocaleString()}</td>
                        <td class="text-center"><span class="badge ${badgeCls}">${sale.paymentStatus}</span></td>
                        <td class="text-right" style="color:#c62828; font-weight:bold;">${unpaidAmt.toLocaleString()}ì›</td>
                    </tr>`;
                });

                tbody.innerHTML = html;
                section.style.display = 'block';

            } catch(e) {
                console.error('ë¯¸ìˆ˜ê¸ˆ ì¡°íšŒ ì—ëŸ¬:', e);
                section.style.display = 'none';
            }
        }

        // ì…ê¸ˆì•¡ ì…ë ¥ ì‹œ íŒíŠ¸ ì—…ë°ì´íŠ¸
        function onAmountInput() {
            const amount = Number(document.getElementById('payment-amount').value) || 0;
            const hint = document.getElementById('amount-hint');
            if (totalReceivable > 0 && amount > 0) {
                if (amount >= totalReceivable) {
                    hint.textContent = `âœ… ì „ì²´ ë¯¸ìˆ˜ê¸ˆ ${totalReceivable.toLocaleString()}ì› ì™„ë‚©`;
                    hint.style.color = '#2e7d32';
                } else {
                    const remaining = totalReceivable - amount;
                    hint.textContent = `ì…ê¸ˆ í›„ ì”ì—¬ ë¯¸ìˆ˜ê¸ˆ: ${remaining.toLocaleString()}ì›`;
                    hint.style.color = '#e65100';
                }
            } else if (totalReceivable > 0) {
                hint.textContent = `ì „ì²´ ë¯¸ìˆ˜ê¸ˆ: ${totalReceivable.toLocaleString()}ì›`;
                hint.style.color = '#c62828';
            }
        }

        // ==========================================
        // ì…ê¸ˆ ë“±ë¡
        // ==========================================

        async function handlePaymentSubmit() {
            const company = document.getElementById('payment-customer').value;
            const date = document.getElementById('payment-date').value;
            const amount = Number(document.getElementById('payment-amount').value);
            const method = document.getElementById('payment-method').value;
            const note = document.getElementById('payment-note').value;

            if (!company) { alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            if (!date) { alert('ì…ê¸ˆì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            if (!amount || amount <= 0) { alert('ì…ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            if (totalReceivable > 0 && amount > totalReceivable) {
                const confirm = window.confirm(`ì…ê¸ˆì•¡(${amount.toLocaleString()}ì›)ì´ ë¯¸ìˆ˜ê¸ˆ(${totalReceivable.toLocaleString()}ì›)ë³´ë‹¤ ë§ìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                if (!confirm) return;
            }

            try {
                const result = await addPayment({
                    date, company, amount, method,
                    note: note || (method + ' ì…ê¸ˆ')
                });

                if (result.success) {
                    alert(`${company} ì…ê¸ˆ ${amount.toLocaleString()}ì›ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\në¯¸ìˆ˜ê¸ˆì´ ìë™ ì°¨ê°ë©ë‹ˆë‹¤.`);
                    resetPaymentForm();
                    await loadPayments();
                } else {
                    alert('ì…ê¸ˆ ë“±ë¡ ì‹¤íŒ¨: ' + result.message);
                }
            } catch(e) {
                alert('ì…ê¸ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + e.message);
            }
        }

        // ==========================================
        // í¼ ì´ˆê¸°í™”
        // ==========================================

        function resetPaymentForm() {
            document.getElementById('customer-search').value = '';
            document.getElementById('payment-customer').value = '';
            document.getElementById('payment-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('payment-amount').value = '';
            document.getElementById('payment-method').value = 'ê³„ì¢Œì´ì²´';
            document.getElementById('payment-note').value = '';
            document.getElementById('receivables-section').style.display = 'none';
            document.getElementById('no-receivable-msg').style.display = 'none';
            document.getElementById('amount-hint').textContent = '';
            currentReceivables = [];
            totalReceivable = 0;
        }

        // ==========================================
        // ì…ê¸ˆ ë‚´ì—­ ë¡œë“œ
        // ==========================================

        async function loadPayments() {
            const tbody = document.getElementById('payments-tbody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const params = {};
                const customer = document.getElementById('filter-customer').value;
                const startDate = document.getElementById('filter-start').value;
                const endDate = document.getElementById('filter-end').value;
                if (customer) params.company = customer;
                if (startDate) params.startDate = startDate;
                if (endDate) params.endDate = endDate;

                const result = await getPayments(params);

                if (!result.success || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                // ìµœì‹ ìˆœ ì •ë ¬
                const sorted = result.data.sort((a, b) => new Date(b.date) - new Date(a.date));

                let html = '';
                sorted.forEach(p => {
                    const methodBadge = p.method === 'íŒë§¤ë“±ë¡' ? 'badge-info' : 'badge-success';
                    html += `<tr>
                        <td>${formatDate(p.date)}</td>
                        <td>${p.company}</td>
                        <td class="text-right" style="font-weight:bold; color:#1976d2;">${p.amount.toLocaleString()}ì›</td>
                        <td class="text-center"><span class="badge ${methodBadge}">${p.method||'-'}</span></td>
                        <td>${p.note||'-'}</td>
                    </tr>`;
                });

                tbody.innerHTML = html;

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        // ==========================================
        // ìœ í‹¸
        // ==========================================

        function formatDate(dateString) {
            try {
                if (!dateString) return '-';
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            } catch(e) { return '-'; }
        }
    </script>

    <style>
        .search-select-wrap {
            position: relative;
        }
        .search-select-wrap input[type="text"] {
            width: 100%;
        }
        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .search-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            border-bottom: 1px solid #f5f5f5;
        }
        .search-item:hover {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: bold;
        }
        .badge-info {
            background: #e3f2fd;
            color: #1565c0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
    </style>
</body>
</html>
