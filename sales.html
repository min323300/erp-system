<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ê´€ë¦¬ - ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html" class="active">íŒë§¤</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">íŒë§¤ ê´€ë¦¬</h1>
            </div>

            <!-- íŒë§¤ ë“±ë¡ í¼ -->
            <section class="card">
                <h2>íŒë§¤ ë“±ë¡</h2>
                <form id="sale-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-date">íŒë§¤ì¼ *</label>
                            <input type="date" id="sale-date" required>
                        </div>
                        <div class="form-group">
                            <label for="sale-customer">ê±°ë˜ì²˜ *</label>
                            <select id="sale-customer" required>
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-delivery">ë°°ì†¡ë°©ì‹</label>
                            <select id="sale-delivery">
                                <option value="ì˜¤í”„ë¼ì¸">ì˜¤í”„ë¼ì¸</option>
                                <option value="íƒë°°">íƒë°°</option>
                                <option value="í€µ">í€µ</option>
                                <option value="ì§ì ‘ë°°ì†¡">ì§ì ‘ë°°ì†¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-box-return">ê³µë°•ìŠ¤íšŒìˆ˜ *</label>
                            <select id="sale-box-return" required>
                                <option value="íšŒìˆ˜">íšŒìˆ˜</option>
                                <option value="ë¯¸íšŒìˆ˜">ë¯¸íšŒìˆ˜</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>ë¶€ê°€ì„¸ ê³„ì‚° ë°©ì‹ *</label>
                            <div style="display: flex; gap: 20px; margin-top: 8px;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tax-type" value="included" checked style="margin-right: 8px;">
                                    ë¶€ê°€ì„¸ í¬í•¨
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tax-type" value="excluded" style="margin-right: 8px;">
                                    ë¶€ê°€ì„¸ ë³„ë„
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-payment-status">ì…ê¸ˆì—¬ë¶€</label>
                            <select id="sale-payment-status">
                                <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
                                <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                                <option value="ë¶€ë¶„ì…ê¸ˆ">ë¶€ë¶„ì…ê¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-payment-amount">ì…ê¸ˆì•¡</label>
                            <input type="number" id="sale-payment-amount" value="0">
                        </div>
                    </div>

                    <!-- í’ˆëª© ì¶”ê°€ ì„¹ì…˜ -->
                    <div class="form-section">
                        <h3>í’ˆëª© ì¶”ê°€</h3>
                        <div id="items-container">
                            <div class="item-row" data-item-index="0">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>í’ˆëª© *</label>
                                        <select class="item-name" required>
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>ìˆ˜ëŸ‰ *</label>
                                        <input type="number" class="item-quantity" value="1" min="1" required>
                                    </div>
                                    <div class="form-group">
                                        <label>ë‹¨ê°€ *</label>
                                        <input type="number" class="item-price" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ì´ë ¥ë²ˆí˜¸</label>
                                        <input type="text" class="item-trace-number" placeholder="12ìë¦¬ ì´ë ¥ë²ˆí˜¸" maxlength="12">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(0)" style="margin-top: 24px;">ì‚­ì œ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addItemRow()">+ í’ˆëª© ì¶”ê°€</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì¼ê´„ ë“±ë¡</button>
                        <button type="button" class="btn btn-secondary" onclick="resetSaleForm()">ì´ˆê¸°í™”</button>
                    </div>
                </form>
            </section>

            <!-- íŒë§¤ ë‚´ì—­ -->
            <section class="card">
                <h2>íŒë§¤ ë‚´ì—­</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-date">ê¸°ê°„ í•„í„°</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="form-group">
                        <label for="filter-customer">ê±°ë˜ì²˜ í•„í„°</label>
                        <select id="filter-customer">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="loadSales()" style="margin-top: 24px;">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ê±°ë˜ì²˜</th>
                                <th>í’ˆëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ë‹¨ê°€</th>
                                <th>ê³µê¸‰ê°€</th>
                                <th>ë¶€ê°€ì„¸</th>
                                <th>í•©ê³„</th>
                                <th>ì…ê¸ˆì—¬ë¶€</th>
                                <th>ë¯¸ìˆ˜ê¸ˆ</th>
                                <th>ë°°ì†¡ë°©ì‹</th>
                                <th>ì´ë ¥ë²ˆí˜¸</th>
                                <th>ê³µë°•ìŠ¤</th>
                                <th>ëª…ì„¸í‘œ</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let itemCounter = 1;

        document.addEventListener('DOMContentLoaded', async function() {
            // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;

            // ë°ì´í„° ë¡œë“œ
            await loadCustomers();
            await loadItemsForSelect();
            await loadSales();
        });

        async function loadCustomers() {
            const result = await getCompanies();
            const customerSelect = document.getElementById('sale-customer');
            const filterSelect = document.getElementById('filter-customer');
            
            if (result.success && result.data.length > 0) {
                const customers = result.data.filter(c => c.type === 'ê±°ë˜ì²˜');
                
                customers.forEach(customer => {
                    const option1 = document.createElement('option');
                    option1.value = customer.name;
                    option1.textContent = customer.name;
                    customerSelect.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = customer.name;
                    option2.textContent = customer.name;
                    filterSelect.appendChild(option2);
                });
            }
        }

        async function loadItemsForSelect() {
            const result = await getItems();
            
            if (result.success && result.data.length > 0) {
                const selects = document.querySelectorAll('.item-name');
                
                selects.forEach(select => {
                    // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "ì„ íƒí•˜ì„¸ìš”" ì œì™¸)
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                    
                    // ìƒˆ ì˜µì…˜ ì¶”ê°€
                    result.data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.name;
                        option.dataset.price = item.price;
                        option.textContent = item.name;
                        select.appendChild(option);
                    });
                });
            }
        }

        function addItemRow() {
            const container = document.getElementById('items-container');
            const newRow = document.createElement('div');
            newRow.className = 'item-row';
            newRow.dataset.itemIndex = itemCounter;
            
            newRow.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>í’ˆëª© *</label>
                        <select class="item-name" required>
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ *</label>
                        <input type="number" class="item-quantity" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ *</label>
                        <input type="number" class="item-price" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ë ¥ë²ˆí˜¸</label>
                        <input type="text" class="item-trace-number" placeholder="12ìë¦¬ ì´ë ¥ë²ˆí˜¸" maxlength="12">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${itemCounter})" style="margin-top: 24px;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            
            container.appendChild(newRow);
            
            // ìƒˆë¡œ ì¶”ê°€ëœ selectì— í’ˆëª© ì˜µì…˜ ì¶”ê°€
            loadItemsForSelect();
            
            // í’ˆëª© ì„ íƒ ì‹œ ê°€ê²© ìë™ ì…ë ¥
            const newSelect = newRow.querySelector('.item-name');
            const newPriceInput = newRow.querySelector('.item-price');
            newSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption.dataset.price) {
                    newPriceInput.value = selectedOption.dataset.price;
                }
            });
            
            itemCounter++;
        }

        function removeItem(index) {
            const itemRow = document.querySelector(`[data-item-index="${index}"]`);
            if (itemRow) {
                const container = document.getElementById('items-container');
                if (container.children.length > 1) {
                    itemRow.remove();
                } else {
                    alert('ìµœì†Œ 1ê°œì˜ í’ˆëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                }
            }
        }

        // í’ˆëª© ì„ íƒ ì‹œ ê°€ê²© ìë™ ì…ë ¥
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('item-name')) {
                const row = e.target.closest('.item-row');
                const priceInput = row.querySelector('.item-price');
                const selectedOption = e.target.options[e.target.selectedIndex];
                
                if (selectedOption.dataset.price) {
                    priceInput.value = selectedOption.dataset.price;
                }
            }
        });

        // í¼ ì œì¶œ
        document.getElementById('sale-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleMultiItemSubmit();
        });

        async function handleMultiItemSubmit() {
            const date = document.getElementById('sale-date').value;
            const customer = document.getElementById('sale-customer').value;
            const delivery = document.getElementById('sale-delivery').value;
            const boxReturn = document.getElementById('sale-box-return').value;
            const paymentStatus = document.getElementById('sale-payment-status').value;
            const paymentAmount = Number(document.getElementById('sale-payment-amount').value);
            
            // ë¶€ê°€ì„¸ ê³„ì‚° ë°©ì‹ ê°€ì ¸ì˜¤ê¸°
            const taxType = document.querySelector('input[name="tax-type"]:checked').value;

            const itemRows = document.querySelectorAll('.item-row');
            const sales = [];

            itemRows.forEach(row => {
                const itemName = row.querySelector('.item-name').value;
                const quantity = Number(row.querySelector('.item-quantity').value);
                const price = Number(row.querySelector('.item-price').value);
                const traceNumber = row.querySelector('.item-trace-number').value || '';

                if (itemName && quantity > 0 && price > 0) {
                    let supplyPrice, vat, total;
                    
                    if (taxType === 'included') {
                        // ë¶€ê°€ì„¸ í¬í•¨: ì…ë ¥ê°€ê²©ì´ ìµœì¢…ê°€ê²©
                        total = price;
                        supplyPrice = Math.round(price / 1.1);
                        vat = price - supplyPrice;
                    } else {
                        // ë¶€ê°€ì„¸ ë³„ë„: ì…ë ¥ê°€ê²©ì´ ê³µê¸‰ê°€ì•¡
                        supplyPrice = price;
                        vat = Math.round(price * 0.1);
                        total = price + vat;
                    }

                    sales.push({
                        date: date,
                        customer: customer,
                        item: itemName,
                        quantity: quantity,
                        price: total,  // í•©ê³„ ê¸ˆì•¡
                        supplyPrice: supplyPrice,
                        vat: vat,
                        total: total,
                        paymentStatus: paymentStatus,
                        paymentAmount: paymentAmount,
                        unpaid: total - paymentAmount,
                        delivery: delivery,
                        traceNumber: traceNumber,
                        boxReturn: boxReturn
                    });
                }
            });

            if (sales.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í’ˆëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ê° í’ˆëª©ë³„ë¡œ ê°œë³„ ì €ì¥
            let successCount = 0;
            for (const sale of sales) {
                const result = await addSale(sale);
                if (result.success) {
                    successCount++;
                }
            }

            if (successCount > 0) {
                alert(`${successCount}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                resetSaleForm();
                await loadSales();
            } else {
                alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function resetSaleForm() {
            document.getElementById('sale-form').reset();
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ì¬ì„¤ì •
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;
            
            // ë¶€ê°€ì„¸ í¬í•¨ ê¸°ë³¸ ì„ íƒ
            document.querySelector('input[name="tax-type"][value="included"]').checked = true;
            
            // í’ˆëª© í–‰ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ë§Œ ë‚¨ê¸°ê¸°)
            const container = document.getElementById('items-container');
            while (container.children.length > 1) {
                container.removeChild(container.lastChild);
            }
            
            // ì²« ë²ˆì§¸ í–‰ ì´ˆê¸°í™”
            const firstRow = container.querySelector('.item-row');
            firstRow.querySelector('.item-name').value = '';
            firstRow.querySelector('.item-quantity').value = '1';
            firstRow.querySelector('.item-price').value = '';
            firstRow.querySelector('.item-trace-number').value = '';
            
            itemCounter = 1;
        }

        async function loadSales() {
            const tbody = document.getElementById('sales-tbody');
            const result = await getSales();
            
            if (result.success && result.data.length > 0) {
                let html = '';
                
                // í•„í„° ì ìš©
                const filterDate = document.getElementById('filter-date').value;
                const filterCustomer = document.getElementById('filter-customer').value;
                
                let filteredData = result.data;
                
                if (filterDate) {
                    filteredData = filteredData.filter(sale => sale.date === filterDate);
                }
                
                if (filterCustomer) {
                    filteredData = filteredData.filter(sale => sale.customer === filterCustomer);
                }
                
                // âœ… ìë™ ì •ë ¬: ë‚ ì§œ â†’ ê±°ë˜ì²˜ ìˆœ
                filteredData.sort((a, b) => {
                    // ë‚ ì§œ ë¹„êµ
                    const dateCompare = new Date(a.date) - new Date(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    
                    // ë‚ ì§œê°€ ê°™ìœ¼ë©´ ê±°ë˜ì²˜ ì´ë¦„ìœ¼ë¡œ ë¹„êµ
                    return (a.customer || '').localeCompare(b.customer || '');
                });
                
                // ë‚ ì§œë³„ë¡œ ê·¸ë£¹í•‘í•˜ì—¬ ê±°ë˜ëª…ì„¸í‘œ ìƒì„± ë²„íŠ¼ ì¶”ê°€
                const groupedByDateAndCustomer = {};
                filteredData.forEach(sale => {
                    const key = `${sale.date}_${sale.customer}`;
                    if (!groupedByDateAndCustomer[key]) {
                        groupedByDateAndCustomer[key] = [];
                    }
                    groupedByDateAndCustomer[key].push(sale);
                });
                
                filteredData.forEach(sale => {
                    const key = `${sale.date}_${sale.customer}`;
                    const isFirstInGroup = groupedByDateAndCustomer[key][0] === sale;
                    const rowSpan = groupedByDateAndCustomer[key].length;
                    
                    html += `<tr>`;
                    
                    if (isFirstInGroup) {
                        html += `
                            <td rowspan="${rowSpan}">${formatDate(sale.date)}</td>
                            <td rowspan="${rowSpan}">${sale.customer}</td>
                        `;
                    }
                    
                    html += `
                        <td>${sale.item}</td>
                        <td class="text-center">${sale.quantity}</td>
                        <td class="text-right">${formatCurrency(sale.price)}</td>
                        <td class="text-right">${formatCurrency(sale.supplyPrice)}</td>
                        <td class="text-right">${formatCurrency(sale.vat)}</td>
                        <td class="text-right">${formatCurrency(sale.total)}</td>
                    `;
                    
                    if (isFirstInGroup) {
                        const paymentBadge = sale.paymentStatus === 'ì…ê¸ˆì™„ë£Œ' ? 'badge-success' : 
                                           sale.paymentStatus === 'ë¶€ë¶„ì…ê¸ˆ' ? 'badge-warning' : 'badge-danger';
                        
                        html += `
                            <td rowspan="${rowSpan}"><span class="badge ${paymentBadge}">${sale.paymentStatus}</span></td>
                            <td rowspan="${rowSpan}" class="text-right">${formatCurrency(sale.unpaid)}</td>
                            <td rowspan="${rowSpan}" class="text-center">${sale.delivery}</td>
                        `;
                    }
                    
                    html += `
                        <td class="text-center">${sale.traceNumber || '-'}</td>
                        <td class="text-center"><span class="badge ${sale.boxReturn === 'íšŒìˆ˜' ? 'badge-success' : 'badge-warning'}">${sale.boxReturn}</span></td>
                    `;
                    
                    if (isFirstInGroup) {
                        html += `
                            <td rowspan="${rowSpan}" class="text-center">
                                <button class="btn btn-sm btn-primary" onclick="generateStatement('${sale.date}', '${sale.customer}')">ğŸ“„ ëª…ì„¸í‘œ</button>
                            </td>
                        `;
                    }
                    
                    html += `</tr>`;
                });
                
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            }
        }

        async function generateStatement(date, customer) {
            // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const formattedDate = formatDate(date);
            const result = await createStatement(formattedDate, customer);
            if (result.success) {
                alert('ê±°ë˜ëª…ì„¸í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.open(result.url, '_blank');
            } else {
                alert('ëª…ì„¸í‘œ ìƒì„± ì‹¤íŒ¨: ' + result.message);
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        function formatCurrency(amount) {
            if (typeof amount !== 'number') return '0';
            return amount.toLocaleString('ko-KR');
        }
    </script>
</body>
</html>
