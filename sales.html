<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ê´€ë¦¬ - ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
    <script>
    if (localStorage.getItem('erp_auth') !== 'ok') {
        location.href = 'login.html';
    }
    </script>
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html" class="active">íŒë§¤</a></li>
                <li><a href="payment.html">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="supplypayment.html">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="monthly.html">ì›”ë³„ì§‘ê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">íŒë§¤ ê´€ë¦¬</h1>
            </div>

            <section class="card">
                <h2>íŒë§¤ ë“±ë¡</h2>
                <form id="sale-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-date">íŒë§¤ì¼ *</label>
                            <input type="date" id="sale-date" required>
                        </div>
                        <div class="form-group">
                            <label>ê±°ë˜ì²˜ *</label>
                            <div class="search-select-wrap">
                                <input type="text" id="customer-search" placeholder="ê±°ë˜ì²˜ ê²€ìƒ‰ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                    oninput="filterCustomerList(this.value)"
                                    onfocus="showCustomerList()"
                                    onblur="setTimeout(()=>hideCustomerList(),200)">
                                <input type="hidden" id="sale-customer">
                                <div id="customer-dropdown" class="search-dropdown" style="display:none;"></div>
                            </div>
                            <small id="custom-price-status" style="color:#1976d2; font-size:12px; margin-top:4px; display:block;"></small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-delivery">ë°°ì†¡ë°©ì‹</label>
                            <select id="sale-delivery">
                                <option value="ì˜¤í”„ë¼ì¸">ì˜¤í”„ë¼ì¸</option>
                                <option value="íƒë°°">íƒë°°</option>
                                <option value="í€µ">í€µ</option>
                                <option value="ì§ì ‘ë°°ì†¡">ì§ì ‘ë°°ì†¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-box-return">ê³µë°•ìŠ¤íšŒìˆ˜ *</label>
                            <select id="sale-box-return" required>
                                <option value="íšŒìˆ˜">íšŒìˆ˜</option>
                                <option value="ë¯¸íšŒìˆ˜">ë¯¸íšŒìˆ˜</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-payment-status">ì…ê¸ˆì—¬ë¶€</label>
                            <select id="sale-payment-status">
                                <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
                                <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                                <option value="ë¶€ë¶„ì…ê¸ˆ">ë¶€ë¶„ì…ê¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-payment-amount">ì…ê¸ˆì•¡</label>
                            <input type="number" id="sale-payment-amount" value="0">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>í’ˆëª© ì¶”ê°€</h3>
                        <div id="items-container"></div>
                        <button type="button" class="btn btn-secondary" onclick="addItemRow()">+ í’ˆëª© ì¶”ê°€</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì¼ê´„ ë“±ë¡</button>
                        <button type="button" class="btn btn-secondary" onclick="resetSaleForm()">ì´ˆê¸°í™”</button>
                    </div>
                </form>
            </section>

            <section class="card">
                <h2>íŒë§¤ ë‚´ì—­</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-date">ê¸°ê°„ í•„í„°</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="form-group">
                        <label>ê±°ë˜ì²˜ í•„í„°</label>
                        <div class="search-select-wrap">
                            <input type="text" id="filter-customer-search" placeholder="ì „ì²´ (ì•ê¸€ì ì…ë ¥)" autocomplete="off"
                                oninput="filterCustomerList2(this.value)"
                                onfocus="showCustomerList2()"
                                onblur="setTimeout(()=>hideCustomerList2(),200)">
                            <input type="hidden" id="filter-customer" value="">
                            <div id="customer-dropdown2" class="search-dropdown" style="display:none;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="loadSales()" style="margin-top: 24px;">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ê±°ë˜ì²˜</th>
                                <th>í’ˆëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ë‹¨ê°€</th>
                                <th>ê³µê¸‰ê°€</th>
                                <th>ë¶€ê°€ì„¸</th>
                                <th>í•©ê³„</th>
                                <th>ì…ê¸ˆì—¬ë¶€</th>
                                <th>ë¯¸ìˆ˜ê¸ˆ</th>
                                <th>ë°°ì†¡ë°©ì‹</th>
                                <th>ì´ë ¥ë²ˆí˜¸</th>
                                <th>ê³µë°•ìŠ¤</th>
                                <th>ëª…ì„¸í‘œ</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let itemCounter = 0;
        let customPriceCache = {};
        let allItems = [];

        // ==========================================
        // í’ˆëª© í–‰ HTML ìƒì„± í•¨ìˆ˜
        // ==========================================
        function createItemRowHTML(index) {
            return `
            <div class="item-row" data-item-index="${index}" style="background:#f9f9f9; border:1px solid #e0e0e0; border-radius:8px; padding:12px; margin-bottom:12px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>í’ˆëª© *</label>
                        <select class="item-name" required onchange="onItemSelect(this)">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ *</label>
                        <input type="number" class="item-quantity" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ * <small class="price-source-badge" style="font-weight:normal; font-size:11px; margin-left:4px;"></small></label>
                        <input type="number" class="item-price" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸ ë°©ì‹ *</label>
                        <div style="display:flex; gap:12px; margin-top:8px; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; cursor:pointer; font-size:13px;">
                                <input type="radio" name="tax-type-${index}" value="included" checked style="margin-right:5px;"> ë¶€ê°€ì„¸í¬í•¨
                            </label>
                            <label style="display:flex; align-items:center; cursor:pointer; font-size:13px;">
                                <input type="radio" name="tax-type-${index}" value="excluded" style="margin-right:5px;"> ë¶€ê°€ì„¸ë³„ë„
                            </label>
                            <label style="display:flex; align-items:center; cursor:pointer; font-size:13px; color:#2e7d32; font-weight:bold;">
                                <input type="radio" name="tax-type-${index}" value="exempt" style="margin-right:5px;"> ğŸŸ¢ ë©´ì„¸
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>ì´ë ¥ë²ˆí˜¸</label>
                        <input type="text" class="item-trace-number" placeholder="12ìë¦¬ ì´ë ¥ë²ˆí˜¸" maxlength="12">
                    </div>
                    <div class="form-group" style="display:flex; align-items:flex-end;">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${index})" style="margin-bottom:2px;">ì‚­ì œ</button>
                    </div>
                </div>
            </div>`;
        }

        // ==========================================
        // ì´ˆê¸°í™”
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
                await loadCustomers();
                await loadAllItems();
                addItemRow(); // ì²« í–‰ ì¶”ê°€
                await loadSales();
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì—ëŸ¬:', error);
            }
        });

        // ==========================================
        // í’ˆëª© ëª©ë¡ ë¡œë“œ (í•œ ë²ˆë§Œ)
        // ==========================================
        async function loadAllItems() {
            try {
                const result = await getItems();
                if (result.success && result.data.length > 0) {
                    allItems = result.data;
                }
            } catch (e) { console.error('í’ˆëª© ë¡œë“œ ì—ëŸ¬:', e); }
        }

        // íŠ¹ì • selectì— í’ˆëª© ì˜µì…˜ ì±„ìš°ê¸°
        function fillItemSelect(sel) {
            while (sel.options.length > 1) sel.remove(1);
            allItems.forEach(item => {
                const opt = new Option(item.name, item.name);
                opt.dataset.price = item.price;
                sel.appendChild(opt);
            });
        }

        // ==========================================
        // ê±°ë˜ì²˜ë³„ ë‹¨ê°€
        // ==========================================
        async function onCustomerChange(company) {
            const statusEl = document.getElementById('custom-price-status');
            customPriceCache = {};
            if (!company) { statusEl.textContent = ''; return; }

            statusEl.textContent = 'â³ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            try {
                const result = await getCustomPrices(company);
                if (result.success && result.data.length > 0) {
                    result.data.forEach(item => {
                        customPriceCache[item.name] = { price: item.price, source: item.source };
                    });
                    const customCount = result.data.filter(i => i.source === 'custom').length;
                    statusEl.textContent = customCount > 0 ? `âœ… ì „ìš©ë‹¨ê°€ ${customCount}ê°œ ì ìš©ë¨` : 'ê¸°ë³¸ ë‹¨ê°€ ì‚¬ìš© ì¤‘';
                    statusEl.style.color = customCount > 0 ? '#1976d2' : '#888';
                    updateAllItemPrices();
                } else {
                    statusEl.textContent = '';
                }
            } catch (e) { statusEl.textContent = ''; }
        }

        function updateAllItemPrices() {
            document.querySelectorAll('.item-row').forEach(row => {
                const sel = row.querySelector('.item-name');
                if (sel && sel.value) applyPriceToRow(row, sel.value);
            });
        }

        function applyPriceToRow(row, itemName) {
            const priceInput = row.querySelector('.item-price');
            const badge = row.querySelector('.price-source-badge');
            if (!itemName) return;
            const cached = customPriceCache[itemName];
            if (cached) {
                priceInput.value = cached.price;
                if (badge) {
                    badge.textContent = cached.source === 'custom' ? 'ğŸ”µ ì „ìš©ë‹¨ê°€' : 'ê¸°ë³¸ë‹¨ê°€';
                    badge.style.color = cached.source === 'custom' ? '#1976d2' : '#888';
                }
            } else {
                const sel = row.querySelector('.item-name');
                const opt = sel ? sel.options[sel.selectedIndex] : null;
                if (opt && opt.dataset.price) {
                    priceInput.value = opt.dataset.price;
                    if (badge) { badge.textContent = 'ê¸°ë³¸ë‹¨ê°€'; badge.style.color = '#888'; }
                }
            }
        }

        function onItemSelect(selectEl) {
            const row = selectEl.closest('.item-row');
            applyPriceToRow(row, selectEl.value);
        }

        // ==========================================
        // ê±°ë˜ì²˜ ë¡œë“œ
        // ==========================================
        let allCustomers = [];

        async function loadCustomers() {
            try {
                const result = await getCompanies();
                if (result.success && result.data.length > 0) {
                    allCustomers = result.data.filter(c => c.type === 'ê±°ë˜ì²˜').map(c => c.name);
                    renderDropdown('customer-dropdown', allCustomers, selectCustomer);
                    renderDropdown('customer-dropdown2', ['ì „ì²´', ...allCustomers], selectCustomer2);
                }
            } catch (e) { console.error('ê±°ë˜ì²˜ ë¡œë“œ ì—ëŸ¬:', e); }
        }

        function renderDropdown(id, list, fn) {
            const dd = document.getElementById(id);
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="${fn.name}('${n}')">${n}</div>`
            ).join('');
        }

        function filterCustomerList(val) {
            const filtered = allCustomers.filter(n => n.includes(val));
            const dd = document.getElementById('customer-dropdown');
            dd.innerHTML = filtered.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectCustomer('${n}')">${n}</div>`
            ).join('');
            dd.style.display = filtered.length ? 'block' : 'none';
        }

        function filterCustomerList2(val) {
            const list = val ? allCustomers.filter(n => n.includes(val)) : ['ì „ì²´', ...allCustomers];
            const dd = document.getElementById('customer-dropdown2');
            dd.innerHTML = list.map(n =>
                `<div class="search-item" onmousedown="event.preventDefault()" onclick="selectCustomer2('${n}')">${n}</div>`
            ).join('');
            dd.style.display = list.length ? 'block' : 'none';
        }

        function showCustomerList() { document.getElementById('customer-dropdown').style.display = 'block'; }
        function hideCustomerList() { document.getElementById('customer-dropdown').style.display = 'none'; }
        function showCustomerList2() { document.getElementById('customer-dropdown2').style.display = 'block'; }
        function hideCustomerList2() { document.getElementById('customer-dropdown2').style.display = 'none'; }

        function selectCustomer(name) {
            document.getElementById('customer-search').value = name;
            document.getElementById('sale-customer').value = name;
            document.getElementById('customer-dropdown').style.display = 'none';
            onCustomerChange(name);
        }

        function selectCustomer2(name) {
            document.getElementById('filter-customer-search').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('filter-customer').value = name === 'ì „ì²´' ? '' : name;
            document.getElementById('customer-dropdown2').style.display = 'none';
        }

        // ==========================================
        // í’ˆëª© í–‰ ì¶”ê°€ / ì‚­ì œ
        // ==========================================
        function addItemRow() {
            const container = document.getElementById('items-container');
            const idx = itemCounter++;
            const div = document.createElement('div');
            div.innerHTML = createItemRowHTML(idx);
            const row = div.firstElementChild;
            container.appendChild(row);

            // ìƒˆ í–‰ì˜ selectì—ë§Œ í’ˆëª© ì±„ìš°ê¸° (ê¸°ì¡´ í–‰ ìœ ì§€)
            const sel = row.querySelector('.item-name');
            fillItemSelect(sel);
        }

        function removeItem(index) {
            const row = document.querySelector(`[data-item-index="${index}"]`);
            if (row) {
                const container = document.getElementById('items-container');
                if (container.children.length > 1) {
                    row.remove();
                } else {
                    alert('ìµœì†Œ 1ê°œì˜ í’ˆëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
                }
            }
        }

        // ==========================================
        // í¼ ì œì¶œ
        // ==========================================
        document.getElementById('sale-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleMultiItemSubmit();
        });

        async function handleMultiItemSubmit() {
            try {
                const date = document.getElementById('sale-date').value;
                const customer = document.getElementById('sale-customer').value;
                const delivery = document.getElementById('sale-delivery').value;
                const boxReturn = document.getElementById('sale-box-return').value;
                const paymentStatus = document.getElementById('sale-payment-status').value;
                const paymentAmount = Number(document.getElementById('sale-payment-amount').value);

                if (!customer) { alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

                const sales = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const idx = row.dataset.itemIndex;
                    const itemName = row.querySelector('.item-name').value;
                    const quantity = Number(row.querySelector('.item-quantity').value);
                    const price = Number(row.querySelector('.item-price').value);
                    const traceNumber = row.querySelector('.item-trace-number').value || '';

                    // âœ… ê° í–‰ì˜ ë¶€ê°€ì„¸ ë°©ì‹ ì½ê¸°
                    const taxRadio = row.querySelector(`input[name="tax-type-${idx}"]:checked`);
                    const taxMode = taxRadio ? taxRadio.value : 'included';

                    if (!itemName || quantity <= 0 || price <= 0) return;

                    let supplyPrice, vat, total;
                    if (taxMode === 'exempt') {
                        total = price; supplyPrice = price; vat = 0;
                    } else if (taxMode === 'included') {
                        total = price;
                        supplyPrice = Math.round(price / 1.1);
                        vat = price - supplyPrice;
                    } else {
                        supplyPrice = price;
                        vat = Math.round(price * 0.1);
                        total = price + vat;
                    }

                    const totalSupply = supplyPrice * quantity;
                    const totalVat = vat * quantity;
                    const totalAmount = total * quantity;

                    sales.push({
                        date, customer, item: itemName, quantity,
                        price: total,
                        supplyPrice: totalSupply,
                        vat: totalVat,
                        total: totalAmount,
                        delivery, traceNumber, boxReturn,
                        taxType: taxMode === 'exempt' ? 'ë©´ì„¸' : 'ê³¼ì„¸'
                    });
                });

                if (sales.length === 0) { alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í’ˆëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

                const grandTotal = sales.reduce((sum, s) => sum + s.total, 0);
                let remainingPayment = paymentAmount;

                sales.forEach((s, idx) => {
                    let itemPayment;
                    if (idx === sales.length - 1) {
                        itemPayment = remainingPayment;
                    } else {
                        itemPayment = grandTotal > 0 ? Math.round(paymentAmount * (s.total / grandTotal)) : 0;
                    }
                    remainingPayment -= itemPayment;
                    s.paymentStatus = paymentStatus;
                    s.paymentAmount = itemPayment;
                    s.unpaid = s.total - itemPayment;
                });

                let successCount = 0;
                for (const sale of sales) {
                    const result = await addSale(sale);
                    if (result.success) successCount++;
                }

                if (successCount > 0) {
                    alert(`${successCount}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    resetSaleForm();
                    await loadSales();
                } else {
                    alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('íŒë§¤ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ==========================================
        // í¼ ì´ˆê¸°í™”
        // ==========================================
        function resetSaleForm() {
            document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('customer-search').value = '';
            document.getElementById('sale-customer').value = '';
            document.getElementById('sale-delivery').value = 'ì˜¤í”„ë¼ì¸';
            document.getElementById('sale-box-return').value = 'ë¯¸íšŒìˆ˜';
            document.getElementById('sale-payment-status').value = 'ë¯¸ì…ê¸ˆ';
            document.getElementById('sale-payment-amount').value = '0';

            // ê¸°ì¡´ í–‰ ëª¨ë‘ ì‚­ì œ í›„ ìƒˆ í–‰ 1ê°œ ì¶”ê°€
            const container = document.getElementById('items-container');
            container.innerHTML = '';
            customPriceCache = {};
            document.getElementById('custom-price-status').textContent = '';
            addItemRow();
        }

        // ==========================================
        // íŒë§¤ ë‚´ì—­ ë¡œë“œ
        // ==========================================
        async function loadSales() {
            const tbody = document.getElementById('sales-tbody');
            tbody.innerHTML = '<tr><td colspan="14" class="text-center">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const result = await getSales();
                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
                    return;
                }
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                const filterDate = document.getElementById('filter-date').value;
                const filterCustomer = document.getElementById('filter-customer').value;

                let filtered = result.data;
                if (filterDate) filtered = filtered.filter(s => formatDate(s.date) === filterDate);
                if (filterCustomer) filtered = filtered.filter(s => s.customer === filterCustomer);

                filtered.sort((a, b) => {
                    const diff = new Date(a.date) - new Date(b.date);
                    return diff !== 0 ? diff : (a.customer || '').localeCompare(b.customer || '', 'ko-KR');
                });

                const grouped = {};
                filtered.forEach(sale => {
                    const key = `${formatDate(sale.date)}_${sale.customer}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(sale);
                });

                const groupUnpaid = {};
                Object.keys(grouped).forEach(key => {
                    groupUnpaid[key] = grouped[key].reduce((sum, s) => sum + (s.unpaid || 0), 0);
                });

                let html = '';
                filtered.forEach(sale => {
                    const key = `${formatDate(sale.date)}_${sale.customer}`;
                    const isFirst = grouped[key][0] === sale;
                    const rowSpan = grouped[key].length;
                    const isExempt = sale.taxType === 'ë©´ì„¸';

                    html += `<tr>`;
                    if (isFirst) {
                        html += `<td rowspan="${rowSpan}">${formatDate(sale.date)}</td>
                                 <td rowspan="${rowSpan}">${sale.customer}</td>`;
                    }

                    const vatDisplay = isExempt
                        ? `<span style="color:#2e7d32; font-weight:bold;">ë©´ì„¸</span>`
                        : formatCurrency(sale.vat);

                    html += `
                        <td>${sale.item}</td>
                        <td class="text-center">${sale.quantity}</td>
                        <td class="text-right">${formatCurrency(sale.price)}</td>
                        <td class="text-right">${formatCurrency(sale.supplyPrice)}</td>
                        <td class="text-right">${vatDisplay}</td>
                        <td class="text-right">${formatCurrency(sale.total)}</td>
                    `;

                    if (isFirst) {
                        const badge = sale.paymentStatus === 'ì…ê¸ˆì™„ë£Œ' ? 'badge-success'
                            : sale.paymentStatus === 'ë¶€ë¶„ì…ê¸ˆ' ? 'badge-warning' : 'badge-danger';
                        html += `
                            <td rowspan="${rowSpan}"><span class="badge ${badge}">${sale.paymentStatus}</span></td>
                            <td rowspan="${rowSpan}" class="text-right">${formatCurrency(groupUnpaid[key])}</td>
                            <td rowspan="${rowSpan}" class="text-center">${sale.delivery}</td>
                        `;
                    }

                    html += `
                        <td class="text-center">${sale.traceNumber || '-'}</td>
                        <td class="text-center"><span class="badge ${sale.boxReturn === 'íšŒìˆ˜' ? 'badge-success' : 'badge-warning'}">${sale.boxReturn}</span></td>
                    `;

                    if (isFirst) {
                        html += `<td rowspan="${rowSpan}" class="text-center">
                            <button class="btn btn-sm btn-primary" onclick="generateStatement('${sale.date}', '${sale.customer}')">ğŸ“„ ëª…ì„¸í‘œ</button>
                        </td>`;
                    }

                    html += `</tr>`;
                });

                tbody.innerHTML = html || '<tr><td colspan="14" class="text-center text-muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        async function generateStatement(date, customer) {
            try {
                const result = await createStatement(formatDate(date), customer);
                if (result.success) {
                    alert('ê±°ë˜ëª…ì„¸í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.open(result.url, '_blank');
                } else {
                    alert('ëª…ì„¸í‘œ ìƒì„± ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ëª…ì„¸í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        function formatDate(dateString) {
            try {
                if (!dateString) return '-';
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            } catch(e) { return '-'; }
        }

        function formatCurrency(amount) {
            try {
                if (typeof amount !== 'number') return '0';
                return amount.toLocaleString('ko-KR');
            } catch(e) { return '0'; }
        }
    </script>
</body>
</html>

<style>
.search-select-wrap { position: relative; }
.search-select-wrap input[type="text"] { width: 100%; }
.search-dropdown {
    position: absolute; top: 100%; left: 0; right: 0;
    background: white; border: 1px solid #ddd; border-radius: 4px;
    max-height: 200px; overflow-y: auto; z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
.search-item { padding: 10px 14px; cursor: pointer; font-size: 14px; border-bottom: 1px solid #f5f5f5; }
.search-item:hover { background: #e3f2fd; color: #1976d2; font-weight: bold; }
</style>
