<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ê´€ë¦¬ - ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html" class="active">íŒë§¤</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">íŒë§¤ ê´€ë¦¬</h1>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('sales')">íŒë§¤ ë“±ë¡</button>
                <button class="tab-button" onclick="switchTab('payments')">ì…ê¸ˆ ë“±ë¡</button>
            </div>

            <!-- íŒë§¤ ë“±ë¡ íƒ­ -->
            <div id="sales-tab" class="tab-content active">
                <section class="card">
                    <h2>ìƒˆ íŒë§¤ ë“±ë¡ (ì—¬ëŸ¬ í’ˆëª©)</h2>
                    
                    <!-- ê³µí†µ ì •ë³´ -->
                    <div class="common-info-section">
                        <h3>ğŸ“… ê³µí†µ ì •ë³´</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sale-date">íŒë§¤ì¼ *</label>
                                <input type="date" id="sale-date" required>
                            </div>
                            <div class="form-group">
                                <label for="sale-company">ê±°ë˜ì²˜ *</label>
                                <select id="sale-company" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sale-paid-status">ì…ê¸ˆì—¬ë¶€</label>
                                <select id="sale-paid-status">
                                    <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
                                    <option value="ë¶€ë¶„ì…ê¸ˆ">ë¶€ë¶„ì…ê¸ˆ</option>
                                    <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sale-delivery-method">ë°°ì†¡ë°©ì‹</label>
                                <select id="sale-delivery-method">
                                    <option value="ì˜¤í”„ë¼ì¸">ğŸš— ì˜¤í”„ë¼ì¸ ë°°ì†¡</option>
                                    <option value="íƒë°°">ğŸ“¦ íƒë°° ë°°ì†¡</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="sale-box-return">ê³µë°•ìŠ¤íšŒìˆ˜</label>
                                <select id="sale-box-return">
                                    <option value="ë¯¸íšŒìˆ˜">ë¯¸íšŒìˆ˜</option>
                                    <option value="íšŒìˆ˜">íšŒìˆ˜</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- í’ˆëª© ì •ë³´ -->
                    <div class="items-section">
                        <h3>ğŸ“¦ í’ˆëª© ì •ë³´</h3>
                        <div id="items-container">
                            <!-- í’ˆëª© í–‰ë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë¨ -->
                        </div>
                        
                        <button type="button" class="btn btn-secondary" onclick="addItemRow()" style="margin-top: 1rem;">
                            â• í’ˆëª© ì¶”ê°€
                        </button>
                    </div>

                    <!-- ì „ì²´ í•©ê³„ -->
                    <div class="total-section">
                        <h3>ğŸ’° ì „ì²´ í•©ê³„</h3>
                        <div class="total-display">
                            <div class="total-row">
                                <span class="total-label">ì´ ê³µê¸‰ê°€:</span>
                                <span class="total-value" id="total-supply-price">0ì›</span>
                            </div>
                            <div class="total-row">
                                <span class="total-label">ì´ ë¶€ê°€ì„¸:</span>
                                <span class="total-value" id="total-vat">0ì›</span>
                            </div>
                            <div class="total-row total-main">
                                <span class="total-label">ì´ ê¸ˆì•¡:</span>
                                <span class="total-value" id="total-amount">0ì›</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-primary" onclick="handleMultiItemSubmit()">ì¼ê´„ ë“±ë¡</button>
                        <button type="button" class="btn btn-secondary" onclick="resetMultiItemForm()">ì´ˆê¸°í™”</button>
                    </div>
                </section>

                <!-- íŒë§¤ ë‚´ì—­ -->
                <section class="card">
                    <h2>íŒë§¤ ë‚´ì—­</h2>
                    
                    <div class="filter-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="filter-company">ê±°ë˜ì²˜</label>
                                <select id="filter-company">
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="filter-start">ì‹œì‘ì¼</label>
                                <input type="date" id="filter-start">
                            </div>
                            <div class="form-group">
                                <label for="filter-end">ì¢…ë£Œì¼</label>
                                <input type="date" id="filter-end">
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="loadSales()">ì¡°íšŒ</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="sales-table">
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ê±°ë˜ì²˜</th>
                                    <th>í’ˆëª©</th>
                                    <th>ìˆ˜ëŸ‰</th>
                                    <th>ë‹¨ê°€</th>
                                    <th>ê³µê¸‰ê°€</th>
                                    <th>ë¶€ê°€ì„¸</th>
                                    <th>í•©ê³„</th>
                                    <th>ì…ê¸ˆì—¬ë¶€</th>
                                    <th>ë‹¹ì¼ë¯¸ìˆ˜ê¸ˆ</th>
                                    <th>ê±°ë˜ì²˜ì´ë¯¸ìˆ˜ê¸ˆ</th>
                                    <th>ë°°ì†¡ë°©ì‹</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="sales-tbody">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </tbody>
                        </table>
                    </div>

                    <!-- ëª¨ë°”ì¼ ì¹´ë“œ ë·° -->
                    <div class="mobile-sales-list" id="mobile-sales-list">
                        <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                    </div>
                </section>
            </div>

            <!-- ì…ê¸ˆ ë“±ë¡ íƒ­ -->
            <div id="payments-tab" class="tab-content">
                <section class="card">
                    <h2>ì…ê¸ˆ ë“±ë¡</h2>
                    <form id="payment-form" onsubmit="handlePaymentSubmit(event)">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="payment-date">ì…ê¸ˆì¼ *</label>
                                <input type="date" id="payment-date" required>
                            </div>
                            <div class="form-group">
                                <label for="payment-company">ê±°ë˜ì²˜ *</label>
                                <select id="payment-company" required>
                                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="payment-amount">ì…ê¸ˆì•¡ *</label>
                                <input type="number" id="payment-amount" required placeholder="0">
                            </div>
                            <div class="form-group">
                                <label for="payment-method">ì…ê¸ˆë°©ë²•</label>
                                <select id="payment-method">
                                    <option value="ê³„ì¢Œì´ì²´">ê³„ì¢Œì´ì²´</option>
                                    <option value="í˜„ê¸ˆ">í˜„ê¸ˆ</option>
                                    <option value="ì¹´ë“œ">ì¹´ë“œ</option>
                                    <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="payment-note">ë¹„ê³ </label>
                            <textarea id="payment-note" rows="3" placeholder="ì…ê¸ˆ ê´€ë ¨ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">ì…ê¸ˆ ë“±ë¡</button>
                            <button type="button" class="btn btn-secondary" onclick="resetPaymentForm()">ì´ˆê¸°í™”</button>
                        </div>
                    </form>
                </section>

                <!-- ì…ê¸ˆ ë‚´ì—­ -->
                <section class="card">
                    <h2>ì…ê¸ˆ ë‚´ì—­</h2>
                    
                    <div class="filter-section">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="payment-filter-company">ê±°ë˜ì²˜</label>
                                <select id="payment-filter-company">
                                    <option value="">ì „ì²´</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="payment-filter-start">ì‹œì‘ì¼</label>
                                <input type="date" id="payment-filter-start">
                            </div>
                            <div class="form-group">
                                <label for="payment-filter-end">ì¢…ë£Œì¼</label>
                                <input type="date" id="payment-filter-end">
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-primary" onclick="loadPayments()">ì¡°íšŒ</button>
                            </div>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table id="payments-table">
                            <thead>
                                <tr>
                                    <th>ì…ê¸ˆì¼</th>
                                    <th>ê±°ë˜ì²˜</th>
                                    <th>ì…ê¸ˆì•¡</th>
                                    <th>ì…ê¸ˆë°©ë²•</th>
                                    <th>ë¹„ê³ </th>
                                </tr>
                            </thead>
                            <tbody id="payments-tbody">
                                <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- ìºì‹œ ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ë²„ì „ íŒŒë¼ë¯¸í„° ì¶”ê°€ -->
    <script src="api.js?v=20260215"></script>
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let itemCounter = 0;
        let availableItems = [];

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            if (tabName === 'sales') {
                document.getElementById('sales-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[0].classList.add('active');
                loadSales();
            } else if (tabName === 'payments') {
                document.getElementById('payments-tab').classList.add('active');
                document.querySelectorAll('.tab-button')[1].classList.add('active');
                loadPayments();
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            setTodayDate();
            await loadCompanies();
            await loadItems();
            await loadSales();
            
            // ì²« ë²ˆì§¸ í’ˆëª© í–‰ ì¶”ê°€
            addItemRow();
        });

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sale-date').value = today;
            document.getElementById('payment-date').value = today;
        }

        async function loadCompanies() {
            const result = await getCompanies();
            if (result.success && result.data.length > 0) {
                const salesSelect = document.getElementById('sale-company');
                const filterSelect = document.getElementById('filter-company');
                const paymentSelect = document.getElementById('payment-company');
                const paymentFilterSelect = document.getElementById('payment-filter-company');
                
                [salesSelect, paymentSelect].forEach(select => {
                    select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                    result.data.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.name;
                        option.textContent = company.name;
                        select.appendChild(option);
                    });
                });

                [filterSelect, paymentFilterSelect].forEach(select => {
                    select.innerHTML = '<option value="">ì „ì²´</option>';
                    result.data.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company.name;
                        option.textContent = company.name;
                        select.appendChild(option);
                    });
                });
            }
        }

        async function loadItems() {
            const result = await getItems();
            if (result.success && result.data.length > 0) {
                availableItems = result.data;
            }
        }

        // í’ˆëª© í–‰ ì¶”ê°€
        function addItemRow() {
            itemCounter++;
            const container = document.getElementById('items-container');
            
            const itemRow = document.createElement('div');
            itemRow.className = 'item-row';
            itemRow.id = `item-row-${itemCounter}`;
            itemRow.dataset.itemId = itemCounter;
            
            let itemOptions = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
            availableItems.forEach(item => {
                itemOptions += `<option value="${item.name}" data-price="${item.price}">${item.name} (${formatCurrency(item.price)})</option>`;
            });
            
            itemRow.innerHTML = `
                <div class="item-row-header">
                    <h4>í’ˆëª© ${itemCounter}</h4>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItemRow(${itemCounter})">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>í’ˆëª© *</label>
                        <select class="item-select" onchange="updateItemPrice(${itemCounter})" required>
                            ${itemOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ *</label>
                        <input type="number" class="item-quantity" min="0" step="0.01" value="1" oninput="calculateItemTotal(${itemCounter})" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ *</label>
                        <input type="number" class="item-price" min="0" oninput="calculateItemTotal(${itemCounter})" required>
                        <small class="price-hint"></small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸</label>
                        <select class="item-vat-included" onchange="calculateItemTotal(${itemCounter})">
                            <option value="true">í¬í•¨</option>
                            <option value="false">ë³„ë„</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ê³µê¸‰ê°€</label>
                        <input type="text" class="item-supply-price" readonly>
                    </div>
                    <div class="form-group">
                        <label>ë¶€ê°€ì„¸</label>
                        <input type="text" class="item-vat" readonly>
                    </div>
                    <div class="form-group">
                        <label>í•©ê³„</label>
                        <input type="text" class="item-total" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ë ¥ë²ˆí˜¸</label>
                        <input type="text" class="item-trace-number" placeholder="012345678901" maxlength="20">
                    </div>
                </div>
            `;
            
            container.appendChild(itemRow);
        }

        // í’ˆëª© í–‰ ì‚­ì œ
        function removeItemRow(itemId) {
            const row = document.getElementById(`item-row-${itemId}`);
            if (row) {
                row.remove();
                calculateGrandTotal();
            }
        }

        // í’ˆëª© ê°€ê²© ìë™ ì…ë ¥
        async function updateItemPrice(itemId) {
            const row = document.getElementById(`item-row-${itemId}`);
            const itemSelect = row.querySelector('.item-select');
            const priceInput = row.querySelector('.item-price');
            const priceHint = row.querySelector('.price-hint');
            const company = document.getElementById('sale-company').value;
            const item = itemSelect.value;
            
            if (!company || !item) return;
            
            try {
                const result = await getLastPrice(company, item);
                
                if (result.success && result.data.price) {
                    priceInput.value = result.data.price;
                    priceHint.textContent = `ğŸ’¡ ìµœê·¼ ê±°ë˜ ê°€ê²©: ${formatCurrency(result.data.price)}`;
                    priceHint.style.color = '#28a745';
                } else {
                    const selectedOption = itemSelect.selectedOptions[0];
                    if (selectedOption) {
                        const defaultPrice = selectedOption.dataset.price;
                        priceInput.value = defaultPrice;
                        priceHint.textContent = `ğŸ’¡ í’ˆëª© ê¸°ë³¸ ë‹¨ê°€: ${formatCurrency(defaultPrice)}`;
                        priceHint.style.color = '#6c757d';
                    }
                }
                
                calculateItemTotal(itemId);
            } catch (error) {
                console.error('ê°€ê²© ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }

        // í’ˆëª©ë³„ í•©ê³„ ê³„ì‚°
        function calculateItemTotal(itemId) {
            const row = document.getElementById(`item-row-${itemId}`);
            const quantity = Number(row.querySelector('.item-quantity').value) || 0;
            const price = Number(row.querySelector('.item-price').value) || 0;
            const vatIncluded = row.querySelector('.item-vat-included').value === 'true';
            
            let supplyPrice, vat, total;
            
            if (vatIncluded) {
                total = quantity * price;
                supplyPrice = Math.round(total / 1.1);
                vat = total - supplyPrice;
            } else {
                supplyPrice = quantity * price;
                vat = Math.round(supplyPrice * 0.1);
                total = supplyPrice + vat;
            }
            
            row.querySelector('.item-supply-price').value = formatCurrency(supplyPrice);
            row.querySelector('.item-vat').value = formatCurrency(vat);
            row.querySelector('.item-total').value = formatCurrency(total);
            
            calculateGrandTotal();
        }

        // ì „ì²´ í•©ê³„ ê³„ì‚°
        function calculateGrandTotal() {
            const rows = document.querySelectorAll('.item-row');
            let totalSupply = 0;
            let totalVat = 0;
            let grandTotal = 0;
            
            rows.forEach(row => {
                const quantity = Number(row.querySelector('.item-quantity').value) || 0;
                const price = Number(row.querySelector('.item-price').value) || 0;
                const vatIncluded = row.querySelector('.item-vat-included').value === 'true';
                
                let supply, vat, total;
                
                if (vatIncluded) {
                    total = quantity * price;
                    supply = Math.round(total / 1.1);
                    vat = total - supply;
                } else {
                    supply = quantity * price;
                    vat = Math.round(supply * 0.1);
                    total = supply + vat;
                }
                
                totalSupply += supply;
                totalVat += vat;
                grandTotal += total;
            });
            
            document.getElementById('total-supply-price').textContent = formatCurrency(totalSupply);
            document.getElementById('total-vat').textContent = formatCurrency(totalVat);
            document.getElementById('total-amount').textContent = formatCurrency(grandTotal);
        }

        // ì—¬ëŸ¬ í’ˆëª© ì¼ê´„ ë“±ë¡
        async function handleMultiItemSubmit() {
            const company = document.getElementById('sale-company').value;
            const date = document.getElementById('sale-date').value;
            const paidStatus = document.getElementById('sale-paid-status').value;
            const deliveryMethod = document.getElementById('sale-delivery-method').value;
            const boxReturn = document.getElementById('sale-box-return').value;
            
            if (!company || !date) {
                alert('íŒë§¤ì¼ê³¼ ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const rows = document.querySelectorAll('.item-row');
            if (rows.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í’ˆëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const items = [];
            let hasError = false;
            
            rows.forEach(row => {
                const itemSelect = row.querySelector('.item-select');
                const quantity = Number(row.querySelector('.item-quantity').value);
                const price = Number(row.querySelector('.item-price').value);
                const traceNumber = row.querySelector('.item-trace-number').value;
                
                if (!itemSelect.value || !quantity || !price) {
                    hasError = true;
                    return;
                }
                
                const vatIncluded = row.querySelector('.item-vat-included').value === 'true';
                
                let supplyPrice, vat, total;
                
                if (vatIncluded) {
                    total = quantity * price;
                    supplyPrice = Math.round(total / 1.1);
                    vat = total - supplyPrice;
                } else {
                    supplyPrice = quantity * price;
                    vat = Math.round(supplyPrice * 0.1);
                    total = supplyPrice + vat;
                }
                
                items.push({
                    date: date,
                    company: company,
                    item: itemSelect.value,
                    quantity: quantity,
                    price: price,
                    supplyPrice: supplyPrice,
                    vat: vat,
                    total: total,
                    paid: paidStatus,
                    paidAmount: paidStatus === 'ì™„ë£Œ' ? total : 0,
                    receivable: paidStatus === 'ì™„ë£Œ' ? 0 : total,
                    deliveryMethod: deliveryMethod,
                    traceNumber: traceNumber || '',
                    boxReturn: boxReturn
                });
            });
            
            if (hasError) {
                alert('ëª¨ë“  í’ˆëª©ì˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìˆœì°¨ì ìœ¼ë¡œ ë“±ë¡
            let successCount = 0;
            for (const item of items) {
                const result = await addSale(item);
                if (result.success) {
                    successCount++;
                } else {
                    console.error('ë“±ë¡ ì‹¤íŒ¨:', item, result.message);
                }
            }
            
            if (successCount === items.length) {
                alert(`${successCount}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                resetMultiItemForm();
                await loadSales();
            } else {
                alert(`${successCount}/${items.length}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.\nì¼ë¶€ í’ˆëª© ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                await loadSales();
            }
        }

        // í¼ ì´ˆê¸°í™”
        function resetMultiItemForm() {
            document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('sale-company').value = '';
            document.getElementById('sale-paid-status').value = 'ë¯¸ì…ê¸ˆ';
            document.getElementById('sale-delivery-method').value = 'ì˜¤í”„ë¼ì¸';
            document.getElementById('sale-box-return').value = 'ë¯¸íšŒìˆ˜';
            
            document.getElementById('items-container').innerHTML = '';
            itemCounter = 0;
            addItemRow();
            
            calculateGrandTotal();
        }

        async function handlePaymentSubmit(e) {
            e.preventDefault();

            const formData = {
                date: document.getElementById('payment-date').value,
                company: document.getElementById('payment-company').value,
                amount: Number(document.getElementById('payment-amount').value),
                method: document.getElementById('payment-method').value,
                note: document.getElementById('payment-note').value || ''
            };

            try {
                const result = await addPayment(formData);

                if (result.success) {
                    showMessage('ì…ê¸ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    resetPaymentForm();
                    await loadPayments();
                    await loadSales();
                } else {
                    showMessage(result.message || 'ì…ê¸ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showMessage('ì…ê¸ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                console.error(error);
            }
        }

        async function loadPayments() {
            const tbody = document.getElementById('payments-tbody');
            showLoading(tbody);

            const params = {};
            const company = document.getElementById('payment-filter-company').value;
            const startDate = document.getElementById('payment-filter-start').value;
            const endDate = document.getElementById('payment-filter-end').value;

            if (company) params.company = company;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;

            try {
                const result = await getPayments(params);

                if (result.success) {
                    if (result.data.length === 0) {
                        showEmpty(tbody, 'ì…ê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
                        return;
                    }

                    let html = '';
                    result.data.forEach(payment => {
                        html += `
                            <tr>
                                <td>${formatDate(payment.date)}</td>
                                <td>${payment.company}</td>
                                <td class="text-right"><strong>${formatCurrency(payment.amount)}</strong></td>
                                <td class="text-center">
                                    <span class="badge badge-info">${payment.method}</span>
                                </td>
                                <td>${payment.note || '-'}</td>
                            </tr>
                        `;
                    });

                    tbody.innerHTML = html;
                } else {
                    showMessage('ì…ê¸ˆ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
                }
            } catch (error) {
                showMessage('ì…ê¸ˆ ë‚´ì—­ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'danger');
                console.error(error);
            }
        }

        async function loadSales() {
            const tbody = document.getElementById('sales-tbody');
            const mobileList = document.getElementById('mobile-sales-list');
            showLoading(tbody);
            
            const params = {};
            const company = document.getElementById('filter-company').value;
            const startDate = document.getElementById('filter-start').value;
            const endDate = document.getElementById('filter-end').value;
            
            if (company) params.company = company;
            if (startDate) params.startDate = startDate;
            if (endDate) params.endDate = endDate;
            
            const result = await getSales(params);
            
            if (result.success) {
                if (result.data.length === 0) {
                    showEmpty(tbody, 'íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
                    mobileList.innerHTML = '<div class="mobile-sale-card" style="text-align:center; color:#999;">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
                    return;
                }
                
                let tableHtml = '';
                let mobileHtml = '';
                
                result.data.forEach((sale, index) => {
                    let totalReceivableClass = 'badge-success';
                    if (sale.companyTotalReceivable > 100000) {
                        totalReceivableClass = 'badge-danger';
                    } else if (sale.companyTotalReceivable > 0) {
                        totalReceivableClass = 'badge-warning';
                    }
                    
                    // í…Œì´ë¸” HTML (ë°ìŠ¤í¬í†±)
                    tableHtml += `
                        <tr>
                            <td>${formatDate(sale.date)}</td>
                            <td>${sale.company}</td>
                            <td>${sale.item}</td>
                            <td class="text-right">${sale.quantity}</td>
                            <td class="text-right">${formatCurrency(sale.price)}</td>
                            <td class="text-right">${formatCurrency(sale.supplyPrice)}</td>
                            <td class="text-right">${formatCurrency(sale.vat)}</td>
                            <td class="text-right"><strong>${formatCurrency(sale.total)}</strong></td>
                            <td class="text-center">
                                <span class="badge ${sale.paid === 'ì™„ë£Œ' ? 'badge-success' : 'badge-warning'}">
                                    ${sale.paid}
                                </span>
                            </td>
                            <td class="text-right ${sale.receivable > 0 ? 'text-danger' : ''}">
                                ${formatCurrency(sale.receivable)}
                            </td>
                            <td class="text-center">
                                <span class="badge ${totalReceivableClass}" style="font-weight: bold; font-size: 0.9em;">
                                    ${formatCurrency(sale.companyTotalReceivable)}
                                </span>
                            </td>
                            <td class="text-center">
                                <span class="badge ${sale.deliveryMethod === 'íƒë°°' ? 'badge-info' : 'badge-secondary'}">
                                    ${sale.deliveryMethod === 'íƒë°°' ? 'ğŸ“¦ íƒë°°' : 'ğŸš— ì˜¤í”„ë¼ì¸'}
                                </span>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-danger btn-sm" onclick="printStatement(${index})">
                                    ğŸ“„ ëª…ì„¸í‘œ
                                </button>
                            </td>
                        </tr>
                    `;
                    
                    // ëª¨ë°”ì¼ ì¹´ë“œ HTML
                    mobileHtml += `
                        <div class="mobile-sale-card">
                            <div class="mobile-sale-header">
                                <div>
                                    <div class="mobile-sale-date">${formatDate(sale.date)}</div>
                                    <div class="mobile-sale-company">${sale.company}</div>
                                </div>
                                <span class="badge ${sale.paid === 'ì™„ë£Œ' ? 'badge-success' : sale.paid === 'ë¶€ë¶„ì…ê¸ˆ' ? 'badge-warning' : 'badge-danger'}">
                                    ${sale.paid}
                                </span>
                            </div>
                            
                            <div class="mobile-sale-info">
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">í’ˆëª©</span>
                                    <span class="mobile-sale-value">${sale.item}</span>
                                </div>
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">ìˆ˜ëŸ‰ Ã— ë‹¨ê°€</span>
                                    <span class="mobile-sale-value">${sale.quantity} Ã— ${formatCurrency(sale.price)}</span>
                                </div>
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">í•©ê³„</span>
                                    <span class="mobile-sale-total">${formatCurrency(sale.total)}</span>
                                </div>
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">ë‹¹ì¼ ë¯¸ìˆ˜ê¸ˆ</span>
                                    <span class="mobile-sale-value" style="color: ${sale.receivable > 0 ? '#d32f2f' : '#2e7d32'}; font-weight: bold;">
                                        ${formatCurrency(sale.receivable)}
                                    </span>
                                </div>
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">ê±°ë˜ì²˜ ì´ë¯¸ìˆ˜ê¸ˆ</span>
                                    <span class="mobile-sale-value" style="color: ${sale.companyTotalReceivable > 0 ? '#d32f2f' : '#2e7d32'}; font-weight: bold;">
                                        ${formatCurrency(sale.companyTotalReceivable)}
                                    </span>
                                </div>
                                <div class="mobile-sale-row">
                                    <span class="mobile-sale-label">ë°°ì†¡ë°©ì‹</span>
                                    <span class="badge ${sale.deliveryMethod === 'íƒë°°' ? 'badge-info' : 'badge-secondary'}">
                                        ${sale.deliveryMethod === 'íƒë°°' ? 'ğŸ“¦ íƒë°°' : 'ğŸš— ì˜¤í”„ë¼ì¸'}
                                    </span>
                                </div>
                            </div>
                            
                            <div class="mobile-sale-actions">
                                <button class="btn btn-danger btn-sm" onclick="printStatement(${index})" style="width: 100%;">
                                    ğŸ“„ ê±°ë˜ëª…ì„¸í‘œ ìƒì„±
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                tbody.innerHTML = tableHtml;
                mobileList.innerHTML = mobileHtml;
            } else {
                showMessage('íŒë§¤ ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'danger');
            }
        }
        
        async function printStatement(index) {
            try {
                const result = await generateStatement(index);

                if (result.success) {
                    alert('ê±°ë˜ëª…ì„¸í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nGoogle Sheetsì˜ "ê±°ë˜ëª…ì„¸í‘œ" ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\níŒŒì¼ > ì¸ì‡„ (Ctrl+P)ë¡œ PDF ì €ì¥ ë˜ëŠ” ì¸ì‡„ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                } else {
                    alert('ê±°ë˜ëª…ì„¸í‘œ ìƒì„± ì‹¤íŒ¨: ' + (result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                alert('ê±°ë˜ëª…ì„¸í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        }

        function resetPaymentForm() {
            document.getElementById('payment-form').reset();
            setTodayDate();
        }
    </script>

    <style>
        .common-info-section,
        .items-section,
        .total-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .item-row {
            background: white;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .item-row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #1976d2;
        }

        .item-row-header h4 {
            margin: 0;
            color: #1976d2;
        }

        .total-display {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .total-row.total-main {
            border-bottom: none;
            border-top: 2px solid #1976d2;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }

        .total-row.total-main .total-label,
        .total-row.total-main .total-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1976d2;
        }

        .price-hint {
            display: block;
            margin-top: 0.25rem;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .item-row {
                padding: 1rem;
            }

            .item-row-header h4 {
                font-size: 1rem;
            }

            .total-row.total-main .total-label,
            .total-row.total-main .total-value {
                font-size: 1.1rem;
            }
        }
    </style>
</body>
</html>
