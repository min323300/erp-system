<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>íŒë§¤ ê´€ë¦¬ - ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html" class="active">íŒë§¤</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">íŒë§¤ ê´€ë¦¬</h1>
            </div>

            <section class="card">
                <h2>íŒë§¤ ë“±ë¡</h2>
                <form id="sale-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-date">íŒë§¤ì¼ *</label>
                            <input type="date" id="sale-date" required>
                        </div>
                        <div class="form-group">
                            <label for="sale-customer">ê±°ë˜ì²˜ *</label>
                            <!-- âœ… v18: ê±°ë˜ì²˜ ë³€ê²½ ì‹œ ì—…ì²´ë³„ ë‹¨ê°€ ìë™ ë¡œë“œ -->
                            <select id="sale-customer" required onchange="onCustomerChange(this.value)">
                                <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                            </select>
                            <small id="custom-price-status" style="color:#1976d2; font-size:12px; margin-top:4px; display:block;"></small>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-delivery">ë°°ì†¡ë°©ì‹</label>
                            <select id="sale-delivery">
                                <option value="ì˜¤í”„ë¼ì¸">ì˜¤í”„ë¼ì¸</option>
                                <option value="íƒë°°">íƒë°°</option>
                                <option value="í€µ">í€µ</option>
                                <option value="ì§ì ‘ë°°ì†¡">ì§ì ‘ë°°ì†¡</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-box-return">ê³µë°•ìŠ¤íšŒìˆ˜ *</label>
                            <select id="sale-box-return" required>
                                <option value="íšŒìˆ˜">íšŒìˆ˜</option>
                                <option value="ë¯¸íšŒìˆ˜">ë¯¸íšŒìˆ˜</option>
                            </select>
                        </div>
                    </div>

                    <!-- âœ… v18: ë©´ì„¸ ì˜µì…˜ ì¶”ê°€ -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>ë¶€ê°€ì„¸ ê³„ì‚° ë°©ì‹ *</label>
                            <div style="display: flex; gap: 20px; margin-top: 8px; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tax-type" value="included" checked style="margin-right: 8px;">
                                    ë¶€ê°€ì„¸ í¬í•¨
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer;">
                                    <input type="radio" name="tax-type" value="excluded" style="margin-right: 8px;">
                                    ë¶€ê°€ì„¸ ë³„ë„
                                </label>
                                <label style="display: flex; align-items: center; cursor: pointer; color: #2e7d32; font-weight: bold;">
                                    <input type="radio" name="tax-type" value="exempt" style="margin-right: 8px;">
                                    ğŸŸ¢ ë©´ì„¸
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="sale-payment-status">ì…ê¸ˆì—¬ë¶€</label>
                            <select id="sale-payment-status">
                                <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
                                <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
                                <option value="ë¶€ë¶„ì…ê¸ˆ">ë¶€ë¶„ì…ê¸ˆ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="sale-payment-amount">ì…ê¸ˆì•¡</label>
                            <input type="number" id="sale-payment-amount" value="0">
                        </div>
                    </div>

                    <div class="form-section">
                        <h3>í’ˆëª© ì¶”ê°€</h3>
                        <div id="items-container">
                            <div class="item-row" data-item-index="0">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>í’ˆëª© *</label>
                                        <!-- âœ… v18: í’ˆëª© ì„ íƒ ì‹œ onItemSelect í˜¸ì¶œ -->
                                        <select class="item-name" required onchange="onItemSelect(this)">
                                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>ìˆ˜ëŸ‰ *</label>
                                        <input type="number" class="item-quantity" value="1" min="1" required>
                                    </div>
                                    <div class="form-group">
                                        <!-- âœ… v18: ë‹¨ê°€ ì¶œì²˜ ë±ƒì§€ -->
                                        <label>ë‹¨ê°€ * <small class="price-source-badge" style="font-weight:normal; font-size:11px; margin-left:4px;"></small></label>
                                        <input type="number" class="item-price" required>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>ì´ë ¥ë²ˆí˜¸</label>
                                        <input type="text" class="item-trace-number" placeholder="12ìë¦¬ ì´ë ¥ë²ˆí˜¸" maxlength="12">
                                    </div>
                                    <div class="form-group">
                                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(0)" style="margin-top: 24px;">ì‚­ì œ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addItemRow()">+ í’ˆëª© ì¶”ê°€</button>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì¼ê´„ ë“±ë¡</button>
                        <button type="button" class="btn btn-secondary" onclick="resetSaleForm()">ì´ˆê¸°í™”</button>
                    </div>
                </form>
            </section>

            <section class="card">
                <h2>íŒë§¤ ë‚´ì—­</h2>
                <div class="form-row">
                    <div class="form-group">
                        <label for="filter-date">ê¸°ê°„ í•„í„°</label>
                        <input type="date" id="filter-date">
                    </div>
                    <div class="form-group">
                        <label for="filter-customer">ê±°ë˜ì²˜ í•„í„°</label>
                        <select id="filter-customer">
                            <option value="">ì „ì²´</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-primary" onclick="loadSales()" style="margin-top: 24px;">ì¡°íšŒ</button>
                    </div>
                </div>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ë‚ ì§œ</th>
                                <th>ê±°ë˜ì²˜</th>
                                <th>í’ˆëª©</th>
                                <th>ìˆ˜ëŸ‰</th>
                                <th>ë‹¨ê°€</th>
                                <th>ê³µê¸‰ê°€</th>
                                <th>ë¶€ê°€ì„¸</th>
                                <th>í•©ê³„</th>
                                <th>ì…ê¸ˆì—¬ë¶€</th>
                                <th>ë¯¸ìˆ˜ê¸ˆ</th>
                                <th>ë°°ì†¡ë°©ì‹</th>
                                <th>ì´ë ¥ë²ˆí˜¸</th>
                                <th>ê³µë°•ìŠ¤</th>
                                <th>ëª…ì„¸í‘œ</th>
                            </tr>
                        </thead>
                        <tbody id="sales-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        let itemCounter = 1;

        // âœ… v18: ê±°ë˜ì²˜ë³„ ë‹¨ê°€ ìºì‹œ
        let customPriceCache = {};

        // ==========================================
        // ì´ˆê¸°í™”
        // ==========================================

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
                await loadCustomers();
                await loadItemsForSelect();
                await loadSales();
            } catch (error) {
                console.error('âŒ ì´ˆê¸°í™” ì—ëŸ¬:', error);
            }
        });

        // ==========================================
        // âœ… v18: ê±°ë˜ì²˜ ë³€ê²½ â†’ ì—…ì²´ë³„ ë‹¨ê°€ ë¡œë“œ
        // ==========================================

        async function onCustomerChange(company) {
            const statusEl = document.getElementById('custom-price-status');
            customPriceCache = {};
            if (!company) { statusEl.textContent = ''; return; }

            statusEl.textContent = 'â³ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
            statusEl.style.color = '#888';

            try {
                const result = await getCustomPrices(company);
                if (result.success && result.data.length > 0) {
                    result.data.forEach(item => {
                        customPriceCache[item.name] = { price: item.price, source: item.source };
                    });

                    const customCount = result.data.filter(i => i.source === 'custom').length;
                    statusEl.textContent = customCount > 0
                        ? `âœ… ì „ìš©ë‹¨ê°€ ${customCount}ê°œ ì ìš©ë¨`
                        : 'ê¸°ë³¸ ë‹¨ê°€ ì‚¬ìš© ì¤‘ (ì „ìš©ë‹¨ê°€ ì—†ìŒ)';
                    statusEl.style.color = customCount > 0 ? '#1976d2' : '#888';

                    // ì´ë¯¸ ì„ íƒëœ í’ˆëª© ë‹¨ê°€ ê°±ì‹ 
                    updateAllItemPrices();
                } else {
                    statusEl.textContent = '';
                }
            } catch (e) {
                console.error('âŒ ê±°ë˜ì²˜ë³„ ë‹¨ê°€ ë¡œë“œ ì—ëŸ¬:', e);
                statusEl.textContent = '';
            }
        }

        // í˜„ì¬ í–‰ë“¤ ë‹¨ê°€ ì „ì²´ ê°±ì‹ 
        function updateAllItemPrices() {
            document.querySelectorAll('.item-row').forEach(row => {
                const sel = row.querySelector('.item-name');
                if (sel && sel.value) applyPriceToRow(row, sel.value);
            });
        }

        // íŠ¹ì • í–‰ì— ë‹¨ê°€ ì ìš©: ê±°ë˜ì²˜ ì „ìš©ë‹¨ê°€ â†’ í’ˆëª© ê¸°ë³¸ë‹¨ê°€ ìˆœ
        function applyPriceToRow(row, itemName) {
            const priceInput = row.querySelector('.item-price');
            const badge = row.querySelector('.price-source-badge');
            if (!itemName) return;

            const cached = customPriceCache[itemName];
            if (cached) {
                priceInput.value = cached.price;
                if (badge) {
                    badge.textContent = cached.source === 'custom' ? 'ğŸ”µ ì „ìš©ë‹¨ê°€' : 'ê¸°ë³¸ë‹¨ê°€';
                    badge.style.color = cached.source === 'custom' ? '#1976d2' : '#888';
                }
            } else {
                // ìºì‹œ ì—†ìœ¼ë©´ option data-price ì‚¬ìš©
                const sel = row.querySelector('.item-name');
                const opt = sel ? sel.options[sel.selectedIndex] : null;
                if (opt && opt.dataset.price) {
                    priceInput.value = opt.dataset.price;
                    if (badge) { badge.textContent = 'ê¸°ë³¸ë‹¨ê°€'; badge.style.color = '#888'; }
                }
            }
        }

        // í’ˆëª© ì„ íƒ ì´ë²¤íŠ¸
        function onItemSelect(selectEl) {
            const row = selectEl.closest('.item-row');
            applyPriceToRow(row, selectEl.value);
        }

        // ==========================================
        // ê±°ë˜ì²˜ / í’ˆëª© ë¡œë“œ
        // ==========================================

        async function loadCustomers() {
            try {
                const result = await getCompanies();
                if (result.success && result.data.length > 0) {
                    const customers = result.data.filter(c => c.type === 'ê±°ë˜ì²˜');
                    const sel1 = document.getElementById('sale-customer');
                    const sel2 = document.getElementById('filter-customer');
                    customers.forEach(c => {
                        sel1.appendChild(new Option(c.name, c.name));
                        sel2.appendChild(new Option(c.name, c.name));
                    });
                }
            } catch (e) { console.error('âŒ ê±°ë˜ì²˜ ë¡œë“œ ì—ëŸ¬:', e); }
        }

        async function loadItemsForSelect() {
            try {
                const result = await getItems();
                if (result.success && result.data.length > 0) {
                    document.querySelectorAll('.item-name').forEach(sel => {
                        while (sel.options.length > 1) sel.remove(1);
                        result.data.forEach(item => {
                            const opt = new Option(item.name, item.name);
                            opt.dataset.price = item.price;
                            sel.appendChild(opt);
                        });
                    });
                }
            } catch (e) { console.error('âŒ í’ˆëª© ë¡œë“œ ì—ëŸ¬:', e); }
        }

        // ==========================================
        // í’ˆëª© í–‰ ì¶”ê°€ / ì‚­ì œ
        // ==========================================

        function addItemRow() {
            const container = document.getElementById('items-container');
            const div = document.createElement('div');
            div.className = 'item-row';
            div.dataset.itemIndex = itemCounter;
            div.innerHTML = `
                <div class="form-row">
                    <div class="form-group">
                        <label>í’ˆëª© *</label>
                        <select class="item-name" required onchange="onItemSelect(this)">
                            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ìˆ˜ëŸ‰ *</label>
                        <input type="number" class="item-quantity" value="1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>ë‹¨ê°€ * <small class="price-source-badge" style="font-weight:normal; font-size:11px; margin-left:4px;"></small></label>
                        <input type="number" class="item-price" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>ì´ë ¥ë²ˆí˜¸</label>
                        <input type="text" class="item-trace-number" placeholder="12ìë¦¬ ì´ë ¥ë²ˆí˜¸" maxlength="12">
                    </div>
                    <div class="form-group">
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${itemCounter})" style="margin-top: 24px;">ì‚­ì œ</button>
                    </div>
                </div>
            `;
            container.appendChild(div);
            loadItemsForSelect();
            itemCounter++;
        }

        function removeItem(index) {
            const row = document.querySelector(`[data-item-index="${index}"]`);
            if (row) {
                const container = document.getElementById('items-container');
                container.children.length > 1 ? row.remove() : alert('ìµœì†Œ 1ê°œì˜ í’ˆëª©ì€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.');
            }
        }

        // ==========================================
        // í¼ ì œì¶œ
        // ==========================================

        document.getElementById('sale-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            await handleMultiItemSubmit();
        });

        async function handleMultiItemSubmit() {
            try {
                const date = document.getElementById('sale-date').value;
                const customer = document.getElementById('sale-customer').value;
                const delivery = document.getElementById('sale-delivery').value;
                const boxReturn = document.getElementById('sale-box-return').value;
                const paymentStatus = document.getElementById('sale-payment-status').value;
                const paymentAmount = Number(document.getElementById('sale-payment-amount').value);
                const taxMode = document.querySelector('input[name="tax-type"]:checked').value;
                // taxMode: 'included' | 'excluded' | 'exempt'

                const sales = [];
                document.querySelectorAll('.item-row').forEach(row => {
                    const itemName = row.querySelector('.item-name').value;
                    const quantity = Number(row.querySelector('.item-quantity').value);
                    const price = Number(row.querySelector('.item-price').value);
                    const traceNumber = row.querySelector('.item-trace-number').value || '';

                    if (!itemName || quantity <= 0 || price <= 0) return;

                    let supplyPrice, vat, total;

                    if (taxMode === 'exempt') {
                        // âœ… ë©´ì„¸: ë¶€ê°€ì„¸ 0, ê³µê¸‰ê°€ = íŒë§¤ê°€
                        total = price;
                        supplyPrice = price;
                        vat = 0;
                    } else if (taxMode === 'included') {
                        total = price;
                        supplyPrice = Math.round(price / 1.1);
                        vat = price - supplyPrice;
                    } else {
                        supplyPrice = price;
                        vat = Math.round(price * 0.1);
                        total = price + vat;
                    }

                    sales.push({
                        date, customer, item: itemName, quantity,
                        price: total, supplyPrice, vat, total,
                        paymentStatus, paymentAmount,
                        unpaid: total - paymentAmount,
                        delivery, traceNumber, boxReturn,
                        taxType: taxMode === 'exempt' ? 'ë©´ì„¸' : 'ê³¼ì„¸'  // âœ… v18
                    });
                });

                if (sales.length === 0) { alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ í’ˆëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

                let successCount = 0;
                for (const sale of sales) {
                    const result = await addSale(sale);
                    if (result.success) successCount++;
                }

                if (successCount > 0) {
                    alert(`${successCount}ê°œ í’ˆëª©ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    resetSaleForm();
                    await loadSales();
                } else {
                    alert('ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('âŒ íŒë§¤ ë“±ë¡ ì—ëŸ¬:', error);
                alert('íŒë§¤ ë“±ë¡ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ==========================================
        // í¼ ì´ˆê¸°í™”
        // ==========================================

        function resetSaleForm() {
            document.getElementById('sale-form').reset();
            document.getElementById('sale-date').value = new Date().toISOString().split('T')[0];
            document.querySelector('input[name="tax-type"][value="included"]').checked = true;

            const container = document.getElementById('items-container');
            while (container.children.length > 1) container.removeChild(container.lastChild);

            const first = container.querySelector('.item-row');
            first.querySelector('.item-name').value = '';
            first.querySelector('.item-quantity').value = '1';
            first.querySelector('.item-price').value = '';
            first.querySelector('.item-trace-number').value = '';
            const badge = first.querySelector('.price-source-badge');
            if (badge) badge.textContent = '';

            customPriceCache = {};
            document.getElementById('custom-price-status').textContent = '';
            itemCounter = 1;
        }

        // ==========================================
        // íŒë§¤ ë‚´ì—­ ë¡œë“œ
        // ==========================================

        async function loadSales() {
            const tbody = document.getElementById('sales-tbody');
            tbody.innerHTML = '<tr><td colspan="14" class="text-center">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const result = await getSales();
                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">ë¡œë“œ ì‹¤íŒ¨: ${result.message || ''}</td></tr>`;
                    return;
                }
                if (!result.data || result.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="14" class="text-center text-muted">íŒë§¤ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                    return;
                }

                const filterDate = document.getElementById('filter-date').value;
                const filterCustomer = document.getElementById('filter-customer').value;

                let filtered = result.data;
                if (filterDate) filtered = filtered.filter(s => formatDate(s.date) === filterDate);
                if (filterCustomer) filtered = filtered.filter(s => s.customer === filterCustomer);

                filtered.sort((a, b) => {
                    const diff = new Date(a.date) - new Date(b.date);
                    return diff !== 0 ? diff : (a.customer || '').localeCompare(b.customer || '', 'ko-KR');
                });

                // ë‚ ì§œ+ê±°ë˜ì²˜ ê·¸ë£¹í•‘
                const grouped = {};
                filtered.forEach(sale => {
                    const key = `${formatDate(sale.date)}_${sale.customer}`;
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(sale);
                });

                let html = '';
                filtered.forEach(sale => {
                    const key = `${formatDate(sale.date)}_${sale.customer}`;
                    const isFirst = grouped[key][0] === sale;
                    const rowSpan = grouped[key].length;
                    const isExempt = sale.taxType === 'ë©´ì„¸';

                    html += `<tr>`;
                    if (isFirst) {
                        html += `<td rowspan="${rowSpan}">${formatDate(sale.date)}</td>
                                 <td rowspan="${rowSpan}">${sale.customer}</td>`;
                    }

                    // âœ… v18: ìˆ˜ëŸ‰ ê³±í•˜ê¸°ë¡œ ì‹¤ì œ ê¸ˆì•¡ ê³„ì‚°
                    const qty = sale.quantity || 1;
                    const displaySupply = sale.supplyPrice * qty;
                    const displayVatAmt = sale.vat * qty;
                    const displayTotal = sale.total * qty;
                    const displayUnpaid = sale.unpaid * qty;

                    // ë©´ì„¸ì´ë©´ ë¶€ê°€ì„¸ ì¹¸ì— 'ë©´ì„¸' í‘œì‹œ
                    const vatDisplay = isExempt
                        ? `<span style="color:#2e7d32; font-weight:bold;">ë©´ì„¸</span>`
                        : formatCurrency(displayVatAmt);

                    html += `
                        <td>${sale.item}</td>
                        <td class="text-center">${qty}</td>
                        <td class="text-right">${formatCurrency(sale.price)}</td>
                        <td class="text-right">${formatCurrency(displaySupply)}</td>
                        <td class="text-right">${vatDisplay}</td>
                        <td class="text-right">${formatCurrency(displayTotal)}</td>
                    `;

                    if (isFirst) {
                        const badge = sale.paymentStatus === 'ì…ê¸ˆì™„ë£Œ' ? 'badge-success'
                            : sale.paymentStatus === 'ë¶€ë¶„ì…ê¸ˆ' ? 'badge-warning' : 'badge-danger';
                        html += `
                            <td rowspan="${rowSpan}"><span class="badge ${badge}">${sale.paymentStatus}</span></td>
                            <td rowspan="${rowSpan}" class="text-right">${formatCurrency(displayUnpaid)}</td>
                            <td rowspan="${rowSpan}" class="text-center">${sale.delivery}</td>
                        `;
                    }

                    html += `
                        <td class="text-center">${sale.traceNumber || '-'}</td>
                        <td class="text-center"><span class="badge ${sale.boxReturn === 'íšŒìˆ˜' ? 'badge-success' : 'badge-warning'}">${sale.boxReturn}</span></td>
                    `;

                    if (isFirst) {
                        html += `<td rowspan="${rowSpan}" class="text-center">
                            <button class="btn btn-sm btn-primary" onclick="generateStatement('${sale.date}', '${sale.customer}')">ğŸ“„ ëª…ì„¸í‘œ</button>
                        </td>`;
                    }

                    html += `</tr>`;
                });

                tbody.innerHTML = html || '<tr><td colspan="14" class="text-center text-muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';

            } catch (error) {
                console.error('âŒ loadSales ì—ëŸ¬:', error);
                tbody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">ì˜¤ë¥˜: ${error.message}</td></tr>`;
            }
        }

        // ==========================================
        // ëª…ì„¸í‘œ ìƒì„±
        // ==========================================

        async function generateStatement(date, customer) {
            try {
                const result = await createStatement(formatDate(date), customer);
                if (result.success) {
                    alert('ê±°ë˜ëª…ì„¸í‘œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    window.open(result.url, '_blank');
                } else {
                    alert('ëª…ì„¸í‘œ ìƒì„± ì‹¤íŒ¨: ' + result.message);
                }
            } catch (error) {
                alert('ëª…ì„¸í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ==========================================
        // ìœ í‹¸
        // ==========================================

        function formatDate(dateString) {
            try {
                if (!dateString) return '-';
                const d = new Date(dateString);
                if (isNaN(d.getTime())) return '-';
                return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
            } catch(e) { return '-'; }
        }

        function formatCurrency(amount) {
            try {
                if (typeof amount !== 'number') return '0';
                return amount.toLocaleString('ko-KR');
            } catch(e) { return '0'; }
        }
    </script>
</body>
</html>
