<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›”ë³„ ì§‘ê³„ - ERP</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="payment.html">ì…ê¸ˆ</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="supplypayment.html">ì§€ê¸‰</a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="monthly.html" class="active">ì›”ë³„ì§‘ê³„</a></li>
                <li><a href="settings.html">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì›”ë³„ ì§‘ê³„</h1>
            </div>

            <section class="card">
                <!-- ì—°ë„ ì„ íƒ -->
                <div class="form-row" style="align-items:flex-end; margin-bottom:20px;">
                    <div class="form-group">
                        <label for="report-year">ì—°ë„</label>
                        <select id="report-year" onchange="loadReport()"></select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="loadReport()">ğŸ”„ ì¡°íšŒ</button>
                    </div>
                </div>

                <!-- ìš”ì•½ ì¹´ë“œ -->
                <div id="summary-cards" style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:16px; margin-bottom:24px;">
                    <div class="card stat-card">
                        <div class="stat-icon" style="background:#e3f2fd;">ğŸ’µ</div>
                        <div class="stat-content">
                            <div class="stat-label">ì—°ê°„ ì´ë§¤ì¶œ</div>
                            <div class="stat-value" id="sum-total-sales" style="font-size:1.1rem;">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon" style="background:#fff3e0;">ğŸ§¾</div>
                        <div class="stat-content">
                            <div class="stat-label">ì—°ê°„ ë§¤ì¶œë¶€ê°€ì„¸</div>
                            <div class="stat-value" id="sum-sales-vat" style="font-size:1.1rem;">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon" style="background:#f3e5f5;">ğŸŒ¿</div>
                        <div class="stat-content">
                            <div class="stat-label">ì—°ê°„ ë©´ì„¸ë§¤ì¶œ</div>
                            <div class="stat-value" id="sum-exempt" style="font-size:1.1rem;">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon" style="background:#ffebee;">ğŸ“¦</div>
                        <div class="stat-content">
                            <div class="stat-label">ì—°ê°„ ì´ì…ê³ </div>
                            <div class="stat-value" id="sum-purchase" style="font-size:1.1rem;">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon" style="background:#e8f5e9;">ğŸ’°</div>
                        <div class="stat-content">
                            <div class="stat-label">ì—°ê°„ ìˆœì´ìµ</div>
                            <div class="stat-value" id="sum-profit" style="font-size:1.1rem;">-</div>
                        </div>
                    </div>
                </div>

                <!-- ì›”ë³„ í…Œì´ë¸” -->
                <div class="table-responsive">
                    <table id="monthly-table">
                        <thead>
                            <tr>
                                <th style="width:60px;">ì›”</th>
                                <th class="text-right">ê³¼ì„¸ë§¤ì¶œ<br><small style="font-weight:normal;">(ê³µê¸‰ê°€)</small></th>
                                <th class="text-right">ë§¤ì¶œ<br>ë¶€ê°€ì„¸</th>
                                <th class="text-right">ë©´ì„¸<br>ë§¤ì¶œ</th>
                                <th class="text-right" style="background:#e3f2fd;">ì´ ë§¤ì¶œ</th>
                                <th class="text-right">ì´ ì…ê³ </th>
                                <th class="text-right">ì…ê³ <br>ë¶€ê°€ì„¸</th>
                                <th class="text-right" style="background:#e8f5e9;">ìˆœ ì´ìµ</th>
                                <th class="text-right">ì´ìµë¥ </th>
                            </tr>
                        </thead>
                        <tbody id="monthly-tbody">
                            <tr><td colspan="9" class="text-center">ë¡œë”© ì¤‘...</td></tr>
                        </tbody>
                        <tfoot id="monthly-tfoot"></tfoot>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initYearSelect();
            loadReport();
        });

        function initYearSelect() {
            const sel = document.getElementById('report-year');
            const now = new Date().getFullYear();
            for (let y = now; y >= now - 3; y--) {
                sel.appendChild(new Option(y + 'ë…„', y));
            }
        }

        async function loadReport() {
            const year = document.getElementById('report-year').value;
            const tbody = document.getElementById('monthly-tbody');
            const tfoot = document.getElementById('monthly-tfoot');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center">ë¡œë”© ì¤‘...</td></tr>';
            tfoot.innerHTML = '';

            try {
                const result = await getYearlyReport(year);
                if (!result.success) {
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">${result.message}</td></tr>`;
                    return;
                }

                const { months, totals } = result.data;

                // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
                document.getElementById('sum-total-sales').textContent = fmt(totals.totalSales);
                document.getElementById('sum-total-sales').style.color = '#1976d2';
                document.getElementById('sum-sales-vat').textContent = fmt(totals.salesVat);
                document.getElementById('sum-exempt').textContent = fmt(totals.exemptSales);
                document.getElementById('sum-exempt').style.color = '#388e3c';
                document.getElementById('sum-purchase').textContent = fmt(totals.totalPurchase);
                document.getElementById('sum-profit').textContent = fmt(totals.profit);
                document.getElementById('sum-profit').style.color = totals.profit >= 0 ? '#2e7d32' : '#d32f2f';

                // ì›”ë³„ í–‰
                let html = '';
                months.forEach(m => {
                    const hasData = m.totalSales > 0 || m.totalPurchase > 0;
                    const margin = m.totalSales > 0 ? Math.round((m.profit / m.totalSales) * 100) : 0;
                    const rowStyle = hasData ? '' : 'color:#ccc;';
                    const profitColor = m.profit > 0 ? '#2e7d32' : m.profit < 0 ? '#d32f2f' : '#999';
                    const marginColor = margin >= 20 ? '#2e7d32' : margin >= 10 ? '#f57c00' : margin < 0 ? '#d32f2f' : '#999';

                    html += `<tr style="${rowStyle}">
                        <td class="text-center"><strong>${m.month}ì›”</strong></td>
                        <td class="text-right">${hasData ? fmt(m.taxSales) : '-'}</td>
                        <td class="text-right">${hasData ? fmt(m.salesVat) : '-'}</td>
                        <td class="text-right" style="color:#388e3c;">${m.exemptSales > 0 ? fmt(m.exemptSales) : '-'}</td>
                        <td class="text-right" style="background:#f5faff; font-weight:bold; color:#1976d2;">${hasData ? fmt(m.totalSales) : '-'}</td>
                        <td class="text-right">${hasData ? fmt(m.totalPurchase) : '-'}</td>
                        <td class="text-right">${hasData ? fmt(m.purchaseVat) : '-'}</td>
                        <td class="text-right" style="background:#f5fff5; font-weight:bold; color:${profitColor};">${hasData ? fmt(m.profit) : '-'}</td>
                        <td class="text-right" style="color:${marginColor};">${hasData ? margin + '%' : '-'}</td>
                    </tr>`;
                });
                tbody.innerHTML = html;

                // í•©ê³„ í–‰
                const totalMargin = totals.totalSales > 0 ? Math.round((totals.profit / totals.totalSales) * 100) : 0;
                tfoot.innerHTML = `<tr style="background:#1976d2; color:white; font-weight:bold;">
                    <td class="text-center">í•©ê³„</td>
                    <td class="text-right">${fmt(totals.taxSales)}</td>
                    <td class="text-right">${fmt(totals.salesVat)}</td>
                    <td class="text-right">${fmt(totals.exemptSales)}</td>
                    <td class="text-right" style="background:#1565c0;">${fmt(totals.totalSales)}</td>
                    <td class="text-right">${fmt(totals.totalPurchase)}</td>
                    <td class="text-right">${fmt(totals.purchaseVat)}</td>
                    <td class="text-right" style="background:${totals.profit>=0?'#1b5e20':'#b71c1c'};">${fmt(totals.profit)}</td>
                    <td class="text-right">${totalMargin}%</td>
                </tr>`;

            } catch(e) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        function fmt(n) {
            if (!n && n !== 0) return '-';
            return Number(n).toLocaleString() + 'ì›';
        }
    </script>

    <style>
        #monthly-table th { 
            background: #1976d2; color: white; 
            text-align: center; padding: 10px 8px;
            font-size: 13px; line-height: 1.4;
        }
        #monthly-table td { padding: 10px 12px; font-size: 13px; }
        #monthly-table tbody tr:hover { background: #f0f7ff !important; }
        #monthly-table tfoot td { padding: 12px; font-size: 14px; }
        .stat-value { font-size: 1rem !important; }
    </style>
</body>
</html>
