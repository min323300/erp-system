<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„¤ì • - ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="index.html">ê±°ë˜ëª…ì„¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</a>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="sales.html">íŒë§¤</a></li>
                <li><a href="purchase.html">ì…ê³ </a></li>
                <li><a href="inventory.html">ì¬ê³ </a></li>
                <li><a href="accounting.html">íšŒê³„</a></li>
                <li><a href="settings.html" class="active">ì„¤ì •</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">ì„¤ì •</h1>
            </div>

            <!-- íšŒì‚¬ ì •ë³´ -->
            <section class="card">
                <h2>íšŒì‚¬ ì •ë³´</h2>
                <form id="company-form" onsubmit="handleCompanySubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="company-name">íšŒì‚¬ëª… *</label>
                            <input type="text" id="company-name" required>
                        </div>
                        <div class="form-group">
                            <label for="business-number">ì‚¬ì—…ìë²ˆí˜¸</label>
                            <input type="text" id="business-number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ceo">ëŒ€í‘œì</label>
                            <input type="text" id="ceo">
                        </div>
                        <div class="form-group">
                            <label for="phone">ì „í™”ë²ˆí˜¸</label>
                            <input type="tel" id="phone">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="address">ì£¼ì†Œ</label>
                            <input type="text" id="address">
                        </div>
                        <div class="form-group">
                            <label for="email">ì´ë©”ì¼</label>
                            <input type="email" id="email">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì €ì¥</button>
                    </div>
                </form>
            </section>

            <!-- âœ… v18 ì‹ ê·œ: ê±°ë˜ì²˜ë³„ ë‹¨ê°€ ê´€ë¦¬ -->
            <section class="card">
                <h2>ê±°ë˜ì²˜ë³„ ë‹¨ê°€ ê´€ë¦¬</h2>
                <p style="color:#666; font-size:14px; margin-bottom:16px;">
                    ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ë©´ ì „ì²´ í’ˆëª© ë‹¨ê°€ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¨ê°€ë¥¼ ë¹„ì›Œë‘ë©´ ê¸°ë³¸ë‹¨ê°€ê°€ ì ìš©ë©ë‹ˆë‹¤.
                </p>

                <div class="form-row">
                    <div class="form-group">
                        <label for="price-customer">ê±°ë˜ì²˜ ì„ íƒ</label>
                        <select id="price-customer" onchange="loadCustomerPrices(this.value)">
                            <option value="">ê±°ë˜ì²˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    <div class="form-group" style="display:flex; align-items:flex-end;">
                        <button type="button" class="btn btn-primary" onclick="saveAllPrices()" id="save-all-btn" style="display:none;">
                            ğŸ’¾ ì „ì²´ ì €ì¥
                        </button>
                    </div>
                </div>

                <!-- ë‹¨ê°€ í…Œì´ë¸” -->
                <div id="price-table-container" style="display:none;">
                    <div style="background:#e3f2fd; padding:10px 14px; border-radius:6px; margin-bottom:12px; font-size:13px; color:#1565c0;">
                        ğŸ’¡ ë‹¨ê°€ ìˆ˜ì • í›„ <strong>ì „ì²´ ì €ì¥</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”. ë¹ˆì¹¸ì€ ê¸°ë³¸ë‹¨ê°€ë¡œ ì ìš©ë©ë‹ˆë‹¤.
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>í’ˆëª©ëª…</th>
                                    <th class="text-center">ë‹¨ìœ„</th>
                                    <th class="text-right">ê¸°ë³¸ë‹¨ê°€</th>
                                    <th class="text-center" style="width:160px;">ì „ìš©ë‹¨ê°€ ì„¤ì •</th>
                                    <th class="text-center">ìƒíƒœ</th>
                                </tr>
                            </thead>
                            <tbody id="price-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="price-loading" style="display:none; text-align:center; padding:20px; color:#888;">
                    â³ ë‹¨ê°€ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </section>

            <!-- ì—…ì²´ ê´€ë¦¬ -->
            <section class="card">
                <h2>ì—…ì²´ ê´€ë¦¬</h2>
                <form id="vendor-form" onsubmit="handleVendorSubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendor-name">ì—…ì²´ëª… *</label>
                            <input type="text" id="vendor-name" required>
                        </div>
                        <div class="form-group">
                            <label for="vendor-type">êµ¬ë¶„ *</label>
                            <select id="vendor-type" required>
                                <option value="ê±°ë˜ì²˜">ê±°ë˜ì²˜</option>
                                <option value="ê³µê¸‰ì—…ì²´">ê³µê¸‰ì—…ì²´</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendor-business-number">ì‚¬ì—…ìë²ˆí˜¸</label>
                            <input type="text" id="vendor-business-number">
                        </div>
                        <div class="form-group">
                            <label for="vendor-ceo">ëŒ€í‘œì</label>
                            <input type="text" id="vendor-ceo">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="vendor-phone">ì—°ë½ì²˜</label>
                            <input type="tel" id="vendor-phone">
                        </div>
                        <div class="form-group">
                            <label for="vendor-address">ì£¼ì†Œ</label>
                            <input type="text" id="vendor-address">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">ì—…ì²´ ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary" onclick="resetVendorForm()">ì´ˆê¸°í™”</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ì—…ì²´ëª…</th>
                                <th>êµ¬ë¶„</th>
                                <th>ì‚¬ì—…ìë²ˆí˜¸</th>
                                <th>ëŒ€í‘œì</th>
                                <th>ì—°ë½ì²˜</th>
                            </tr>
                        </thead>
                        <tbody id="vendors-tbody"></tbody>
                    </table>
                </div>
            </section>

            <!-- í’ˆëª© ê´€ë¦¬ -->
            <section class="card">
                <h2>í’ˆëª© ê´€ë¦¬</h2>
                <form id="item-form" onsubmit="handleItemSubmit(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="item-name">í’ˆëª©ëª… *</label>
                            <input type="text" id="item-name" required>
                        </div>
                        <div class="form-group">
                            <label for="item-unit">ë‹¨ìœ„</label>
                            <input type="text" id="item-unit" value="ê°œ">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="item-price">ê¸°ë³¸ë‹¨ê°€ *</label>
                            <input type="number" id="item-price" required>
                        </div>
                        <div class="form-group">
                            <label for="item-note">ë¹„ê³ </label>
                            <input type="text" id="item-note">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">í’ˆëª© ì¶”ê°€</button>
                        <button type="button" class="btn btn-secondary" onclick="resetItemForm()">ì´ˆê¸°í™”</button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>í’ˆëª©ëª…</th>
                                <th>ë‹¨ìœ„</th>
                                <th>ê¸°ë³¸ë‹¨ê°€</th>
                                <th>ë¹„ê³ </th>
                            </tr>
                        </thead>
                        <tbody id="items-tbody"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script src="api.js"></script>
    <script>

        // ì „ì²´ í’ˆëª© ìºì‹œ
        let allItemsCache = [];

        document.addEventListener('DOMContentLoaded', async function() {
            await loadCompanyInfo();
            await loadVendors();
            await loadItems();
            await loadCustomerSelectForPrice();
        });

        // ==========================================
        // íšŒì‚¬ ì •ë³´
        // ==========================================

        async function loadCompanyInfo() {
            const result = await getMyCompany();
            if (result.success && result.data) {
                document.getElementById('company-name').value = result.data.name || '';
                document.getElementById('business-number').value = result.data.businessNumber || '';
                document.getElementById('ceo').value = result.data.ceo || '';
                document.getElementById('phone').value = result.data.phone || '';
                document.getElementById('address').value = result.data.address || '';
                document.getElementById('email').value = result.data.email || '';
            }
        }

        async function handleCompanySubmit(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('company-name').value,
                businessNumber: document.getElementById('business-number').value,
                ceo: document.getElementById('ceo').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                email: document.getElementById('email').value
            };
            const result = await saveMyCompany(formData);
            alert(result.success ? 'íšŒì‚¬ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì €ì¥ ì‹¤íŒ¨: ' + result.message);
        }

        // ==========================================
        // âœ… v18: ê±°ë˜ì²˜ë³„ ë‹¨ê°€ ê´€ë¦¬
        // ==========================================

        // ê±°ë˜ì²˜ ì…€ë ‰íŠ¸ ë¡œë“œ
        async function loadCustomerSelectForPrice() {
            try {
                const result = await getCompanies();
                const sel = document.getElementById('price-customer');
                if (result.success && result.data.length > 0) {
                    const customers = result.data.filter(c => c.type === 'ê±°ë˜ì²˜');
                    customers.forEach(c => {
                        sel.appendChild(new Option(c.name, c.name));
                    });
                }

                // í’ˆëª© ì „ì²´ ìºì‹œ
                const itemResult = await getItems();
                if (itemResult.success) allItemsCache = itemResult.data;

            } catch (e) {
                console.error('ê±°ë˜ì²˜ ë‹¨ê°€ ì…€ë ‰íŠ¸ ë¡œë“œ ì—ëŸ¬:', e);
            }
        }

        // ê±°ë˜ì²˜ ì„ íƒ ì‹œ ë‹¨ê°€ í…Œì´ë¸” ë¡œë“œ
        async function loadCustomerPrices(company) {
            const container = document.getElementById('price-table-container');
            const loading = document.getElementById('price-loading');
            const saveBtn = document.getElementById('save-all-btn');

            if (!company) {
                container.style.display = 'none';
                saveBtn.style.display = 'none';
                return;
            }

            container.style.display = 'none';
            loading.style.display = 'block';
            saveBtn.style.display = 'none';

            try {
                const result = await getCustomPrices(company);
                loading.style.display = 'none';

                if (!result.success) {
                    alert('ë‹¨ê°€ ì¡°íšŒ ì‹¤íŒ¨: ' + result.message);
                    return;
                }

                const priceMap = {};
                if (result.data) {
                    result.data.forEach(item => {
                        priceMap[item.name] = item;
                    });
                }

                let html = '';
                allItemsCache.forEach(item => {
                    const priceInfo = priceMap[item.name];
                    const customPrice = priceInfo && priceInfo.source === 'custom' ? priceInfo.price : '';
                    const isCustom = customPrice !== '';

                    html += `
                        <tr id="price-row-${encodeItemName(item.name)}">
                            <td><strong>${item.name}</strong></td>
                            <td class="text-center">${item.unit}</td>
                            <td class="text-right">${item.price.toLocaleString()}ì›</td>
                            <td class="text-center">
                                <input type="number"
                                    id="custom-price-${encodeItemName(item.name)}"
                                    data-item="${item.name}"
                                    data-default="${item.price}"
                                    value="${customPrice}"
                                    placeholder="${item.price.toLocaleString()}"
                                    style="width:120px; text-align:right; padding:4px 8px; border:1px solid #ccc; border-radius:4px; ${isCustom ? 'border-color:#1976d2; background:#e3f2fd;' : ''}"
                                    oninput="onPriceInputChange(this)"
                                >
                            </td>
                            <td class="text-center" id="status-${encodeItemName(item.name)}">
                                ${isCustom
                                    ? `<span style="color:#1976d2; font-weight:bold;">ğŸ”µ ì „ìš©ë‹¨ê°€</span>`
                                    : `<span style="color:#888;">ê¸°ë³¸ë‹¨ê°€</span>`
                                }
                            </td>
                        </tr>
                    `;
                });

                document.getElementById('price-tbody').innerHTML = html;
                container.style.display = 'block';
                saveBtn.style.display = 'inline-block';

            } catch (e) {
                loading.style.display = 'none';
                console.error('ë‹¨ê°€ ë¡œë“œ ì—ëŸ¬:', e);
                alert('ë‹¨ê°€ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë‹¨ê°€ ì…ë ¥ ì‹œ ìƒíƒœ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
        function onPriceInputChange(input) {
            const itemName = input.dataset.item;
            const key = encodeItemName(itemName);
            const statusEl = document.getElementById(`status-${key}`);
            const val = input.value.trim();

            if (val !== '') {
                input.style.borderColor = '#1976d2';
                input.style.background = '#e3f2fd';
                if (statusEl) statusEl.innerHTML = `<span style="color:#e65100; font-weight:bold;">âœï¸ ìˆ˜ì •ì¤‘</span>`;
            } else {
                input.style.borderColor = '#ccc';
                input.style.background = '';
                if (statusEl) statusEl.innerHTML = `<span style="color:#888;">ê¸°ë³¸ë‹¨ê°€</span>`;
            }
        }

        // ì „ì²´ ì €ì¥
        async function saveAllPrices() {
            const company = document.getElementById('price-customer').value;
            if (!company) { alert('ê±°ë˜ì²˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }

            const inputs = document.querySelectorAll('#price-tbody input[data-item]');
            const toSave = [];

            inputs.forEach(input => {
                const itemName = input.dataset.item;
                const val = input.value.trim();
                if (val !== '') {
                    toSave.push({ item: itemName, price: Number(val) });
                }
            });

            if (toSave.length === 0) {
                alert('ì €ì¥í•  ë‹¨ê°€ê°€ ì—†ìŠµë‹ˆë‹¤.\në‹¨ê°€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const saveBtn = document.getElementById('save-all-btn');
            saveBtn.textContent = 'ì €ì¥ ì¤‘...';
            saveBtn.disabled = true;

            let successCount = 0;
            for (const item of toSave) {
                const result = await saveCustomPrice(company, item.item, item.price);
                if (result.success) successCount++;
            }

            saveBtn.textContent = 'ğŸ’¾ ì „ì²´ ì €ì¥';
            saveBtn.disabled = false;

            if (successCount > 0) {
                alert(`${successCount}ê°œ ë‹¨ê°€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                // í…Œì´ë¸” ìƒˆë¡œê³ ì¹¨
                await loadCustomerPrices(company);
            } else {
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // í’ˆëª©ëª… ì¸ì½”ë”© (íŠ¹ìˆ˜ë¬¸ì ì²˜ë¦¬)
        function encodeItemName(name) {
            return name.replace(/[^a-zA-Z0-9ê°€-í£]/g, '_');
        }

        // ==========================================
        // ì—…ì²´ ê´€ë¦¬
        // ==========================================

        async function loadVendors() {
            const tbody = document.getElementById('vendors-tbody');
            const result = await getCompanies();
            if (result.success && result.data.length > 0) {
                let html = '';
                result.data.forEach(vendor => {
                    html += `
                        <tr>
                            <td>${vendor.name}</td>
                            <td><span class="badge badge-info">${vendor.type}</span></td>
                            <td>${vendor.businessNumber || '-'}</td>
                            <td>${vendor.ceo || '-'}</td>
                            <td>${vendor.phone || '-'}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            }
        }

        async function handleVendorSubmit(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('vendor-name').value,
                type: document.getElementById('vendor-type').value,
                businessNumber: document.getElementById('vendor-business-number').value,
                ceo: document.getElementById('vendor-ceo').value,
                phone: document.getElementById('vendor-phone').value,
                address: document.getElementById('vendor-address').value
            };
            const result = await addCompany(formData);
            if (result.success) {
                alert('ì—…ì²´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                resetVendorForm();
                await loadVendors();
            } else {
                alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.message);
            }
        }

        function resetVendorForm() {
            document.getElementById('vendor-form').reset();
        }

        // ==========================================
        // í’ˆëª© ê´€ë¦¬
        // ==========================================

        async function loadItems() {
            const tbody = document.getElementById('items-tbody');
            const result = await getItems();
            if (result.success && result.data.length > 0) {
                allItemsCache = result.data;
                let html = '';
                result.data.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.name}</td>
                            <td class="text-center">${item.unit}</td>
                            <td class="text-right">${item.price.toLocaleString()}ì›</td>
                            <td>${item.note || '-'}</td>
                        </tr>
                    `;
                });
                tbody.innerHTML = html;
            } else {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ë“±ë¡ëœ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
            }
        }

        async function handleItemSubmit(e) {
            e.preventDefault();
            const formData = {
                name: document.getElementById('item-name').value,
                unit: document.getElementById('item-unit').value,
                price: Number(document.getElementById('item-price').value),
                note: document.getElementById('item-note').value
            };
            const result = await addItem(formData);
            if (result.success) {
                alert('í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                resetItemForm();
                await loadItems();
            } else {
                alert('ì¶”ê°€ ì‹¤íŒ¨: ' + result.message);
            }
        }

        function resetItemForm() {
            document.getElementById('item-form').reset();
            document.getElementById('item-unit').value = 'ê°œ';
        }

        function formatCurrency(amount) {
            if (!amount) return '0ì›';
            return new Intl.NumberFormat('ko-KR').format(amount) + 'ì›';
        }
    </script>
</body>
</html>
